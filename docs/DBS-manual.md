# <center>DBS可视化调参仪</center>
## <center>技术手册第一版</center>


<center>编写： 高汉麟 李佳蔚 林熠阳 刘华瑞 杨心月</center>

<center>校对： 高汉麟 宋天成</center>

<center>审核： 王立鹏</center>

<center>批准： 魏彦兆</center>

### <center>北京棋弈智能科技有限公司</center>
##### <center>2018-7-15</center>

---


### 概述
#### 任务来源
为满足DBS手术调参需求，设计该可视化调参仪，用于寻找DBS手术中电刺激仪最合适的参数，在天坛医院实际实验并应用于术前术后恢复程度评估



#### 项目需求
基于上一版进行改进，具体如下：
- 硬件部分
    - 更换屏幕，提高数据传输速度，提高刷新率，用于实时显示波形和频域信息
    - 引入`SPI_Buffer`，利用其严格的时钟周期提高采样稳定性，缓存数据并预处理，提高采样率
    - 增加WiFi-AP功能(第二版受限于OrangePi的WiFi驱动芯片，无法broadcast分享原始数据)
    - 外壳设计和材料选择，以及对应的电磁屏蔽方案(避免遮挡WiFi天线)
    - 电极线的制作(简约整洁)


- 软件部分
    - GUI改进，面向用户更加友好，易于使用
    - 算法设计，调研并实现基于Py/C++的提取震颤、僵直、运动三个系数对应的最佳算法
    - 各种接口的完善

暂不考虑向可穿戴式方向的改进(功耗问题)以及蓝牙调试问题(去除前两版的串口调试功能)


---


### 具体方案
#### 硬件设计
- 屏幕更换
    - [x] Serial screen ==> SPI screen：屏幕刷新率提高约10倍，完全满足数据可视化的需求
        - 扩展板上屏幕预留`FPC-18p`接口
        - 占用GPIO
            - RESET --> GPIO3
            - RS --> GPIO2
            - CS --> CS1(GPIO10)
            - SCL --> CLK(GPIO14)
            - SDA --> MOSI(GPIO15)
            - SDO --> None
            - XL/XR/YU/YD --> **ESP32** ADC*4


- SPI_Buffer
    - [ ] 板载**ESP32**，使用[esp32-arduino-core](https://github.com/espressif/arduino-esp32)，ESP32开启WiFi功能作为Access Point广播数据
        - **CPU0** 作为spi-master从ADS1299读取原始数据
            - 数据预处理，将24bytes-3B-8chs ==> 32bytes-float32(4B)-8chs
            - 维护一个FIFO队列，缓存多组数据再发送
        - **CPU0** 作为spi-slave向ARM发送
            - 通过一个引脚进行握手，ARM通过暴露在用户空间中的系统级中断一次性读取多组数据
        - **CPU0** ADC读取电阻触摸屏信息，如果触摸则serial发送触摸点
        - **CPU0** 开启Bluetooth，SoftwareSerial连接ARM的tty0调试、升级ARM
        - **CPU1** Arduino-WiFi库，如果有client连接则将预处理后的数据广播出去(功耗很大！根据需求取舍)
        - 占用GPIO
            - EN(3) --> GPIO19
            - BOOT(25) --> GPIO18
            - HSPISS(23) --> CS0(GPIO13)
            - HSPICLK(13) --> CLK(GPIO14)
            - HSPIQ(14) --> MOSI(GPIO15)
            - HSPID(16) --> MISO(GPIO16)
            - TXD0(35) --> UART1_RX(GPIO199)
            - RXD0(34) --> UART1_TX(GPIO198)
            - ESP32-DRDY --> GPIO7
            - ESP32-serial --> UART2(GPIO0 | GPIO1)
            - VSPI --> **ADS1299** SPI
            - GPIO --> **ADS1299** DRDY
            - ADC*4(推荐A4 | A5 | A6 | A7) --> **Touch Screen**


- 外壳
    - [ ] 根据最初一版先修改尺寸并3D打印出来，简单的包装一下
    - [ ] 后期寻找工业设计团队做外观包装
        - 如果使用金属材料需考虑WiFi天线问题
        - 如果使用不屏蔽电磁信号的的材质，可以选用PCB金属屏蔽罩，成本低且较为高端



#### 软件设计
- GUI部分：五个界面
    - [ ] 辅助医生/实验者检查被试皮肤表面电极片位置是否正确，粘贴是否牢固(降噪)
        - 可以尝试通过plymouth设置开机动画，显示LOGO
        - 界面一显示各通道阻抗情况，引导粘贴电极片
        - 界面二显示时域波形，引导粘贴牢固，从而噪音减小
        - 界面三显示频域的0-30Hz的freq-time-amp图像，进一步检查
        - 界面四显示肌电信号的三个特征系数，实时更新，用于术前术后的系数锁存
        - 界面五显示summary，并生成检查报告单(python-reportlab | pyPDF2)


- 算法部分：提取三个系数
    - [ ] 震颤
        - 方案一：提取频域信息，感兴趣频段能量和(平均|加和|功率频域积分)，选取最大的一部分
            - STFT(scipy.signal.stft)最快、分辨率可调、结果直观，对数据量要求高
            - DWT(pywavelet.dwt)速度次之，但结果不直观，需要多步后续处理才能得到震颤系数
            - HHT(pyhht.EMD + HSA)
            - 多种方法需要进一步比较，选择最佳算法
        - 方案二：在时域信号上聚类
            - 选取局部最大值，取周围一小段波形作为样本
            - 向两侧截取相同长度数据，与样本求correlation
            - 不断扩大样本长度，直到相关性达到最大
            - 此时样本长度即为周期，就可得到能量最大处对应的中心频率
    - [ ] 僵直
        - stft选取较短的窗，在高频部分可找到对应的峰，能量低
    - [x] 运动
        - 全频域在时域上的积分即为运动系数，衡量被试在一段时间内肌电能量，即运动量


---


### 时间安排
#### 硬件
- PCB设计与制作
    - 负责人 宋天成
    - 完成时间 扩展板2018.7.24，程序2018.7.28
    - 主要任务
        - Audio-Jack、ESP32、ADS1299、FPC-18p座的位置分布
        - 各部分间的连线，画一个系统框图、功能框图
        - 电极线的制作
        - ESP：FIFO、spi-master、spi-slave、serial、ADC、WiFi驱动
        - ESP(GPIO)-DRDY-ARM(Handshake) 和 ESP(BT)-Serial-ARM(Debug)
        - Data：24Bytes-32Bytes
        - 屏蔽罩的可行性与选型


- 外壳设计
    - 负责人 刘华瑞
    - 完成时间 2018.7.28
    - 主要任务
        - 基于前两版的外壳修改尺寸或重新设计
        - 3D打印出来检查配合关系并改进



#### 软件
- 肌电特征系数提取算法
    - 负责人 高汉麟
    - 完成时间 2018.7.20


- ARM端接口和应用层调用
    - 负责人 高汉麟
    - 完成时间 2018.7.20
    - 主要任务
        - 屏幕SPI驱动
        - SPI接口 --> 数据读取、控制屏幕、发送命令
        - GPIO接口 --> DRDY、Interrupt、Reset
        - Serial接口 --> 触摸点读取、发送命令、刷写ESP程序


- GUI由设计到代码
    - 负责人 高汉麟 刘华瑞
    - 完成时间 2018.7.25
    - 主要任务
        - GUI框架完善，提高封装程度但保证运行速度
        - 界面元素位置、颜色、字体等
        - 界面切换回调函数
        - 嵌入提取系数的算法
        - 功能整合



#### 其他
- 技术手册即论文的完善
    - 负责人 李佳蔚 林熠阳 杨心月
    - 完成时间 2018.7.23
    - 主要任务
        - 内容完善
        - 排版工作


---


### 物料清单与预算
| 名称 | 数量 | 单价 | 总价 |
| :-- | :-- | :--- | :-- |
| 电极线 | 10根 | 8 | 80 |
| 3.5mm音频插头 | 5个 | 4 | 20 |
| 扩展板制版 | 1次 | 60 | 60 |
| ESP32 | 1片 | 25 | 25 |
| ADS1299 | 1片 | 200 | 200 |
| SPI触摸屏 | 1个 | 40 | 40 |
| OrangePi0+ | 1块 | 99 | 99 |
| 电子元件 | 1套 | 10 | 10 |
| 总计 |   |   | 535 |
