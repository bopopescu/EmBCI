<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
    <title>Display</title>
    <link rel="stylesheet" href="/css/index.css" />
    <link rel="stylesheet" href="/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/display.css">
    <script src="/js/jquery-2.0.2.min.js"></script>
    <script src="/js/echarts.common.min.js"></script>
    <script src="/js/macarons.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="echart-options.js"></script>
    <script src="callbacks.js"></script>
</head>

<body>
    <div class="top">
        <img src="/images/logo.png" alt="logo" id="logo" align="middle">
        <div class="top-bar">
            <form class="form-inline content-center">
                <div class="odd">
                    <div class="from-group">
                        <label for="name">姓名</label>
                        <input type="text" placeholder="请输入姓名" class="form-control list" id="name" >
                </div>
                    </div>
                    <div class="even">
                        <div class="from-group">
                            <label for="gender">性别</label>
                            <select  id="gender" class="from-control list" style="background-color: #02b2b5;">
                        <option style="display: none">请选择性别</option>
                        <option>男</option>
                        <option>女</option>
                    </select>
                        </div>
                    </div>
                    <div class="odd">
                        <div class="form-group">
                            <label for="age">年龄</label>
                            <input type="number" placeholder="请输入年龄" min="0" max="140" class="form-control list" id="age">
                </div>
                        </div>
                        <div class="even">
                            <div class="form-group">
                                <label for="id">ID</label>
                                <input type="text" placeholder="请输入id" class="form-control list" id="id">
                            </div>
                            </div>
            </form>
        </div>
    </div>
    <div class="plane">
        <div class="display">
            <div class="control">
                <form class="form-inline">
                    <div class="form-group notchtab">
                        <input type="number" min="0" max="20" step="0.1" id="low" class="form-control lh" value="5"> <span class="des">Hz -</span>
                        <input type="number" min="0" max="20" step="0.1" id="high" class="form-control lh" value="10"> <span class="des">Hz</span>
                        <button type="button" class="btn btn-default" id="filter">带通滤波</button>
                        <input type="checkbox" checked="checked" id="notch" class="form-control"> <span class="des">陷波</span>
                        <span class="glyphicon glyphicon-zoom-in zoom" id="bigger"></span>
                        <span class="glyphicon glyphicon-zoom-out zoom" id="smaller"></span>
                    </div>
                </form>
            </div>
            <ul class="nav nav-tabs tab" role="tablist" id="checkboard">
                <li role="presentation" id="0" class="active"><a href="" role="tab" data-toggle="tab">CH1</a></li>
                <li role="presentation" id="1"><a href="" role="tab" data-toggle="tab">CH2</a></li>
                <li role="presentation" id="2"><a href="" role="tab" data-toggle="tab">CH3</a></li>
                <li role="presentation" id="3"><a href="" role="tab" data-toggle="tab">CH4</a></li>
                <li role="presentation" id="4"><a href="" role="tab" data-toggle="tab">CH5</a></li>
                <li role="presentation" id="5"><a href="" role="tab" data-toggle="tab">CH6</a></li>
                <li role="presentation" id="6"><a href="" role="tab" data-toggle="tab">CH7</a></li>
                <li role="presentation" id="7"><a href="" role="tab" data-toggle="tab">CH8</a></li>
            </ul>
            <div class="graph-display1" id="chart1">
            </div>

            <div class="graph-display2" id="chart2">
            </div>
            <div class="data-display">
                <ul>
                    <li>
                        <div class="term tleft ttop digital invisible"></div>
                        <div class="term ttop digital">术前</div>
                        <div class="term ttop digital">术后</div>
                        <div class="term ttop digital">改善率</div>
                    </li>
                    <li>
                        <div class="digital term tleft">震颤</div>
                        <button class="btn btn-primary digital col1" id="bt">test</button>
                        <button class="btn btn-info digital col2" id="at">test</button>
                        <button class="btn btn-success digital col3" id="t">%</button>
                    </li>
                    <li>
                        <div class="digital term tleft">僵直</div>
                        <button class="btn btn-primary digital col1" id="bs">test</button>
                        <button class="btn btn-info digital col2" id="as">test</button>
                        <button class="btn btn-success digital col3" id="s">%</button>
                    </li>
                    <li>
                        <div class="digital term tleft">运动</div>
                        <button class="btn btn-primary digital col1" id="bm">test</button>
                        <button class="btn btn-info digital col2" id="am">test</button>
                        <button class="btn btn-success digital col3" id="m">%</button>
                    </li>
                    <li>
                        <button class="btn btn-primary save" id="save-before">保存</button>
                        <button class="btn btn-info save" id="save-after">保存</button>
                    </li>
                </ul>
            </div>
        </div>
        <div class="bottom-bar">
            <a href="/index.html" class="btn btn-info back digital">返回主页</a>
            <a class="btn btn-info report digital" id="submit">生成报告</a>
        </div>
    </div>
    <div class="bottom">
        &copy; 2018 <a href="http://www.cheitech.com/">杭州航弈生物科技有限责任公司</a> 版权所有
    </div>
    
    <script type="text/javascript">
    $(function() {
        $('#notch').click(function() {
            dataFilter(
                $('#low').val(),
                $('#high').val(),
                this.checked);
        });

        $('#filter').click(function() {
            dataFilter(
                $('#low').val(),
                $('#high').val(),
                $('#notch').get(0).checked
            )
        });

        $('#smaller').click(() => dataScale('minus'));

        $('#bigger').click(() => dataScale('plus'));

        $('#checkboard>li').click(function() {
            var nowColor = colors[this.id];
            option1.series.itemStyle.normal.lineStyle.color = nowColor;
            option2.series.itemStyle.normal.lineStyle.color = nowColor;
            myChart1.setOption(option1);
            myChart2.setOption(option2);
            dataChannel(this.id);
        });

        $('.col3').click(() => $(this).text('%'));

        $('#submit').click(function() {
            var data = {
                username: $('#name').val(),
                gender: $('#gender').val(),
                age: $('#age').val(),
                id: $('#id').val()
            }; 
            genReport(data, function() {
                console.log('用户数据提交成功');
                var btn = document.getElementById('submit');
                btn.text = '查看报告';
                btn.href = 'report.html';
            })
        });

        $('#save-before').click(() => dataConfig({save: 'before'}));

        $('#save-after').click(() => dataConfig({save: 'after'}));

        var myChart1 = echarts.init(document.getElementById('chart1'), 'macarons');
        var myChart2 = echarts.init(document.getElementById('chart2'), 'macarons');
        myChart1.setOption(option1);
        myChart2.setOption(option2);
        window.addEventListener("resize", myChart1.resize);
        window.addEventListener("resize", myChart2.resize);

        var t = 0;

        function animate(listY, time) {
            if (listY.length < 4)
                return;
            var li = [];
            for (var i = 0; i < 5; i++, t += 0.002) {
                if (t >= 1) {
                    t = 0;
                    myChart1.setOption({
                        series: {
                            data: []
                        }
                    })
                }
                li.push([t, listY.splice(0, 1)]);
            }
            myChart1.appendData({
                seriesIndex: 0,
                data: li
            });
            setTimeout(function() {
                animate(listY, time)
            }, time);
        }

        if (!window.WebSocket) {
            alert('您的浏览器不支持websocket，请更换更高级的浏览器')
        } else {
            var ws = new WebSocket('ws://' + location.host + location.pathname.replace('display.html', 'data/websocket'));
            ws.binaryType = 'arraybuffer';

            ws.onopen = function() {
                console.log('websocket success');
            };

            ws.onclose = function() {
                console.log('websocket close');
                ws.close()
            };

            ws.onerror = function() {
                alert('网络错误，请检查网络后刷新重试')
            };

            ws.onmessage = function(msg) {
                var list = new Float32Array(msg.data);
                var li = [];
                for (var i = 0; i < list.length; i++)
                    li.push(list[i]);
                animate(li, 10);
            };
        }

        setInterval(function() {
            $.ajax({
                method: 'GET',
                url: 'data/freq',
                dataType: 'json',
                success: function(msg) {
                    myChart2.setOption({
                        series: {
                            data: msg.data
                        }
                    });
                }
            })
        }, 1500);

        $('#bt').click(() => stateCoef($('#bt').get(0)));
        $('#bs').click(() => stateCoef($('#bs').get(0)));
        $('#bm').click(() => stateCoef($('#bm').get(0)));
        $('#at').click(() => stateCoef($('#at').get(0)));
        $('#as').click(() => stateCoef($('#as').get(0)));
        $('#am').click(() => stateCoef($('#am').get(0)));
    });
    </script>
</body>
</html>