<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>Display</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/font-awesome.min.css" />
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="css/display.css">
    <script src="/js/jquery.min.js"></script>
    <script src="/js/echarts.min.js"></script>
    <script src="/js/macarons.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/sniploader.js"></script>
    <script src="js/callbacks.js?dev=0"></script>
    <script src="js/echart-options.js?dev=1"></script>
</head>

<body>
    <div data-include="navbar.html"></div>
    <div class="top-bar">
        <form class="form-inline content-center">
            <div class="odd">
                <div class="from-group">
                    <label for="name">姓名</label>
                    <input type="text" placeholder="请输入姓名" class="form-control list" id="name">
                </div>
            </div>
            <div class="even">
                <div class="from-group">
                    <label for="gender">性别</label>
                    <select id="gender" class="from-control list" style="background-color: #02b2b5;">
                        <option style="display: none">请选择性别</option>
                        <option>男</option>
                        <option>女</option>
                    </select>
                </div>
            </div>
            <div class="odd">
                <div class="form-group">
                    <label for="age">年龄</label>
                    <input type="number" placeholder="请输入年龄" min="0" max="140" class="form-control list" id="age">
                </div>
            </div>
            <div class="even">
                <div class="form-group">
                    <label for="id">ID</label>
                    <input type="text" placeholder="请输入id" class="form-control list" id="id">
                </div>
            </div>
        </form>
    </div>
    <div class="recorder" style="display:none">
        <form class="collapse" id="username">
            <span class="fa fa-user fold" id="icon-user"></span>
            <input type="text" name="username" placeholder="Username" id="input-username">
            <span class="fa fa-check-circle" id="icon-confirm" style="display:none"></span>
        </form>
        <button id="record" data-toggle="collapse" data-target="#username" aria-expanded="false">
            <span id="icon-record"></span>
        </button>
    </div>
    <div class="plane">
        <div class="control">
            <form class="form-inline">
                <div class="form-group notchtab">
                    <input type="number" min="0" max="20" step="0.1" id="low" class="form-control lh" value="5"> <span class="des">Hz -</span>
                    <input type="number" min="0" max="20" step="0.1" id="high" class="form-control lh" value="10"> <span class="des">Hz</span>
                    <button type="button" class="btn btn-default" id="filter">带通滤波</button>
                    <input type="checkbox" checked="checked" id="notch" class="form-control"><span class="des">陷波</span>
                    <span class="fa fa-search-plus zoom" id="bigger"></span>
                    <span class="fa fa-search-minus zoom" id="smaller"></span>
                    <button type="button" class="btn btn-default" started="false" id="start-stop-record">开始录制数据</button>
                </div>
            </form>
        </div>

        <ul class="nav nav-tabs tab" role="tablist" id="checkboard">
            <li role="presentation" id="0" class="active"><a href="" role="tab" data-toggle="tab">CH1</a></li>
            <li role="presentation" id="1"><a href="" role="tab" data-toggle="tab">CH2</a></li>
            <li role="presentation" id="2"><a href="" role="tab" data-toggle="tab">CH3</a></li>
            <li role="presentation" id="3"><a href="" role="tab" data-toggle="tab">CH4</a></li>
            <li role="presentation" id="4"><a href="" role="tab" data-toggle="tab">CH5</a></li>
            <li role="presentation" id="5"><a href="" role="tab" data-toggle="tab">CH6</a></li>
            <li role="presentation" id="6"><a href="" role="tab" data-toggle="tab">CH7</a></li>
            <li role="presentation" id="7"><a href="" role="tab" data-toggle="tab">CH8</a></li>
        </ul>

        <div class="chart" id="chart-raw"></div>
        <div class="chart" id="chart-pwr"></div>
        <div class="chart" id="chart-coef">
            <ul>
                <li>
                    <div class="term tleft ttop digital invisible"></div>
                    <div class="term ttop digital">术前</div>
                    <div class="term ttop digital">术后</div>
                    <div class="term ttop digital">改善率</div>
                </li>
                <li>
                    <div class="digital term tleft">震颤</div>
                    <button class="btn btn-primary digital col1" id="bt">test</button>
                    <button class="btn btn-info digital col2" id="at">test</button>
                    <button class="btn btn-success digital col3" id="t">%</button>
                </li>
                <li>
                    <div class="digital term tleft">僵直</div>
                    <button class="btn btn-primary digital col1" id="bs">test</button>
                    <button class="btn btn-info digital col2" id="as">test</button>
                    <button class="btn btn-success digital col3" id="s">%</button>
                </li>
                <li>
                    <div class="digital term tleft">运动</div>
                    <button class="btn btn-primary digital col1" id="bm">test</button>
                    <button class="btn btn-info digital col2" id="am">test</button>
                    <button class="btn btn-success digital col3" id="m">%</button>
                </li>
                <li>
                    <button class="btn btn-primary save" id="save-before">保存</button>
                    <button class="btn btn-info save" id="save-after">保存</button>
                </li>
            </ul>
        </div>

        <div class="bottom-bar">
            <a href="/index.html" class="btn btn-info back digital">返回主页</a>
            <a class="btn btn-info report digital" id="submit">生成报告</a>
        </div>
    </div>
    <div class="bottom">
        &copy; 2018-2019 <a href="http://www.cheitech.com/">杭州航弈生物科技有限责任公司</a> 版权所有
    </div>
    <script type="text/javascript">
        $(function() {
            $('button#record').click(function() {
                var expanded = $(this).attr('aria-expanded') == 'true';
                dataConfig({
                    recorder: !expanded ? 'resume' : 'pause'
                });
            });

            $('#input-username').keypress(function() {
                $('#icon-confirm').show(300);
            });

            $('#icon-user').click(function() {
                if ($(this).hasClass('recording')) {
                    checkRecordingUser();
                }
                $(this).toggleClass('fold');
            });

            $('#icon-confirm').click(function() {
                var user = $('#input-username').val();
                if (!user) {
                    $('#input-username').val('');
                } else {
                    dataConfig({
                        recorder: 'username ' + user
                    });
                    $('#icon-user').click();
                }
                $(this).hide(500);
                setTimeout(checkRecordingUser, 1000);
            });

            $('#start-stop-record').click(function() {
                if ($(this).attr('started') == 'true') {
                    dataConfig({
                        recorder: 'username none'
                    });
                    $('.recorder').hide();
                    $(this).attr('started', 'false');
                    $(this).text('开始录制数据');
                    var record = $('button#record');
                    if (record.attr('aria-expanded') == 'true') {
                        record.click();
                    }
                } else {
                    dataConfig({
                        recorder: 'start'
                    });
                    $('.recorder').show();
                    $(this).attr('started', 'true');
                    $(this).text('停止录制数据');
                }
            });

            $('#notch').click(function() {
                dataFilter(
                    $('#low').val(),
                    $('#high').val(),
                    this.checked
                );
            });

            $('#filter').click(function() {
                dataFilter(
                    $('#low').val(),
                    $('#high').val(),
                    $('#notch').get(0).checked
                );
            });

            $('#smaller').click(() => dataScale('minus'));

            $('#bigger').click(() => dataScale('plus'));

            $('#checkboard>li').click(function() {
                var nowColor = colors[this.id];
                dataChannel(this.id);
            });

            $('.col3').click(function() {
                $(this).text('%');
            });

            $('#submit').click(() => genReport({
                username: $('#name').val(),
                gender: $('#gender').val(),
                age: $('#age').val(),
                id: $('#id').val()
            }));

            $('#save-before').click(() => dataConfig({
                save: 'before'
            }));

            $('#save-after').click(() => dataConfig({
                save: 'after'
            }));
            
            $('#bt').click(() => stateCoef($('#bt').get(0)));
            $('#bs').click(() => stateCoef($('#bs').get(0)));
            $('#bm').click(() => stateCoef($('#bm').get(0)));
            $('#at').click(() => stateCoef($('#at').get(0)));
            $('#as').click(() => stateCoef($('#as').get(0)));
            $('#am').click(() => stateCoef($('#am').get(0)));

            
            chart_raw = echarts.init(
                document.getElementById('chart-raw'),
                'macarons', {height: 35 + 50 + 8 * 60}
            );
            chart_pwr = echarts.init(
                document.getElementById('chart-pwr'),
                'macarons', {height: 10 + 35 + 1 * 105}
            );
            chart_raw.setOption(option_raw);
            chart_pwr.setOption(option_pwr);
            window.addEventListener("resize", chart_raw.resize);
            window.addEventListener("resize", chart_pwr.resize);
            
            if (!window.WebSocket) {
                alert('您的浏览器不支持websocket，请更换更高级的浏览器');
                return;
            }
            
            ws = new WebSocket(
                'ws://' + location.host + location.pathname.replace(
                    'display.html', 'data/websocket'
                )
            );
            ws.binaryType = 'arraybuffer';
            ws.onopen = () => console.log('websocket success');
            ws.onclose = () => {console.log('websocket close');ws.close();};
            ws.onerror = () => alert('网络错误，请检查网络后刷新重试');
            ws.onmessage = (msg) => {
                var data = new Float32Array(msg.data);
                var len = data.length / 8, list = [];
                for (var i = 0; i < 8; i++) {
                    list.push(Array.from(data.slice(0, len)));
                }
                update2D(list, 10);
            };
        });
    </script>
</body>

</html>
