

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>embci.utils &mdash; EmBCI v0.2.2 User Guide</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'0.2.2',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> EmBCI
          

          
          </a>

          
            
            
              <div class="version">
                0.2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_zh.html">Get Started 中文</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../hardware/index.html">Hardware Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apis/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../service.html">Linux Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Configurations.html">Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Copyrights.html">Copyrights</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../TODO.html">TODOs</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">EmBCI</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>embci.utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for embci.utils</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># coding=utf-8</span>
<span class="c1">#</span>
<span class="c1"># File: EmBCI/embci/utils/__init__.py</span>
<span class="c1"># Authors: Hank &lt;hankso1106@gmail.com&gt;</span>
<span class="c1"># Create: 2018-02-27 16:03:02</span>

<span class="c1"># built-in</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">fcntl</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">MutableMapping</span><span class="p">,</span> <span class="n">MutableSequence</span>

<span class="c1"># requirements.txt: data: numpy</span>
<span class="c1"># requirements.txt: necessary: decorator, six</span>
<span class="c1"># requirements.txt: optional: argparse</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">decorator</span> <span class="k">import</span> <span class="n">decorator</span>
<span class="kn">from</span> <span class="nn">six</span> <span class="k">import</span> <span class="n">string_types</span><span class="p">,</span> <span class="n">PY2</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="n">StringIO</span><span class="p">,</span> <span class="n">configparser</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Built-in argparse is provided &gt;= 2.7 but argparse</span>
    <span class="c1"># is maintained as a separate package now</span>
    <span class="kn">import</span> <span class="nn">argparse</span>
    <span class="kn">import</span> <span class="nn">packaging.version</span> <span class="k">as</span> <span class="nn">ver</span>
    <span class="k">if</span> <span class="n">ver</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ver</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;1.4.0&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ImportError</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">del</span> <span class="n">argparse</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">argparse</span>                                         <span class="c1"># noqa: W611</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">ver</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">constants</span><span class="p">,</span> <span class="n">configs</span>

<span class="vm">__doc__</span> <span class="o">=</span> <span class="s1">&#39;Some utility functions and classes.&#39;</span>
<span class="n">__basedir__</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Constants</span>

<span class="c1"># save 0, 1, 2 files so that TempStream will not replace these variables.</span>
<span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">stdin</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span>

<span class="c1"># example for mannualy create a logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">hdlr</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
<span class="k">if</span> <span class="n">PY2</span><span class="p">:</span>
    <span class="n">hdlr</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">configs</span><span class="o">.</span><span class="n">LOGFORMAT2</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">hdlr</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">configs</span><span class="o">.</span><span class="n">LOGFORMAT</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;{&#39;</span><span class="p">))</span>
<span class="n">logger</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdlr</span><span class="p">]</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="k">del</span> <span class="n">hdlr</span>
<span class="c1"># you can use embci.utils._logging.config_logger instead, which is better</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">allstr</span> <span class="o">=</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">,)</span>                                         <span class="c1"># noqa: E602</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">allstr</span> <span class="o">=</span> <span class="p">(</span><span class="n">basestring</span><span class="p">,)</span>                                         <span class="c1"># noqa: E602</span>

<span class="kn">from</span> <span class="nn">..testing</span> <span class="k">import</span> <span class="n">PytestRunner</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">PytestRunner</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="k">del</span> <span class="n">PytestRunner</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Utilities</span>

<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">get_caller_globals</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;__name__&#39;</span><span class="p">])</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span> <span class="k">if</span> <span class="n">get_boolean</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;INFO&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">null_func</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">mapping</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_high</span><span class="o">=</span><span class="mi">255</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Mapping data to new array values all in duartion [low, high]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out : ndarray</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; a = [0, 1, 2.5, 4.9, 5]</span>
<span class="sd">    &gt;&gt;&gt; mapping(a, 0, 5, 0, 1024)</span>
<span class="sd">    array([   0.  ,  204.8 ,  512.  , 1003.52, 1024.  ], dtype=float32)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">low</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">low</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">high</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">high</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">low</span> <span class="o">==</span> <span class="n">high</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">t_low</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_high</span> <span class="o">-</span> <span class="n">t_low</span><span class="p">)</span> <span class="o">+</span> <span class="n">t_low</span>


<span class="k">class</span> <span class="nc">NameSpace</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">NameSpace</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">return</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">vars</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">NameSpace</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>


<span class="k">class</span> <span class="nc">AttributeDict</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get items like JavaScript way, i.e. by attributes.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    When getting an attribute of the object, method `__getattribute__` will</span>
<span class="sd">    be called:</span>
<span class="sd">             d.xxx</span>
<span class="sd">        &lt;==&gt; getattr(d, xxx)</span>
<span class="sd">        &lt;==&gt; d.__getattribute__(&#39;xxx&#39;) + d.__getattr__(&#39;xxx&#39;)</span>
<span class="sd">    &gt;&gt;&gt; d = dict(name=&#39;bob&#39;)</span>
<span class="sd">    &gt;&gt;&gt; d.clear  # d.__getattribute__(&#39;clear&#39;)</span>
<span class="sd">    &lt;function clear&gt;</span>

<span class="sd">    If the object doesn&#39;t have that attribute, `__getattribute__` will fail</span>
<span class="sd">    and then `__getattr__` will be called. If `__getattr__` fails too, python</span>
<span class="sd">    will raise `AttributeError`.</span>
<span class="sd">    &gt;&gt;&gt; d = {&#39;name&#39;: &#39;bob&#39;, &#39;age&#39;: 20}</span>
<span class="sd">    &gt;&gt;&gt; d.name</span>
<span class="sd">    AttributeError: &#39;dict&#39; object has no attribute &#39;name&#39;</span>

<span class="sd">    Getting an item from a dict can be achieved by calling __getitem__:</span>
<span class="sd">        d.get(key) &lt;==&gt; return d[key] or default</span>
<span class="sd">        d[key] &lt;==&gt; d.__getitem__(key)</span>
<span class="sd">    &gt;&gt;&gt; d[&#39;age&#39;]</span>
<span class="sd">    KeyError: &#39;age&#39;</span>
<span class="sd">    &gt;&gt;&gt; d.__getitem__(&#39;age&#39;)</span>
<span class="sd">    KeyError: &#39;age&#39;</span>
<span class="sd">    &gt;&gt;&gt; d.get(&#39;age&#39;, 100)</span>
<span class="sd">    100</span>

<span class="sd">    Default `dict.__getattr__` is not defined. Here we link it to `dict.get`.</span>
<span class="sd">    After modification, attributes like `pop`, `keys` can be accessed by</span>
<span class="sd">    `__getattribute__` and items can be accessed by `__getattr__`</span>
<span class="sd">    and `__getitem__`.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; d = AttributeDict({&#39;name&#39;: &#39;bob&#39;, &#39;age&#39;: 20})</span>
<span class="sd">    &gt;&gt;&gt; d.keys  # call d.__getattribute__(&#39;keys&#39;)</span>
<span class="sd">    &lt;function keys&gt;</span>
<span class="sd">    &gt;&gt;&gt; d.name  # call d.__getattr__(&#39;name&#39;), i.e. d.get(&#39;name&#39;, None)</span>
<span class="sd">    &#39;bob&#39;</span>
<span class="sd">    &gt;&gt;&gt; d[&#39;age&#39;]  # call d.__getitem__(&#39;age&#39;)</span>
<span class="sd">    20</span>

<span class="sd">    An element tree can be easily constructed by cascading `AttributeDict`</span>
<span class="sd">    and `list` or `AttributeList`.</span>

<span class="sd">    &gt;&gt;&gt; bob = AttributeDict({&#39;name&#39;: &#39;bob&#39;, &#39;age&#39;: 20, &#39;id&#39;: 1})</span>
<span class="sd">    &gt;&gt;&gt; tim = AttributeDict({&#39;name&#39;: &#39;tim&#39;, &#39;age&#39;: 30, &#39;id&#39;: 2})</span>
<span class="sd">    &gt;&gt;&gt; l = AttributeList([tim, bob])</span>
<span class="sd">    &gt;&gt;&gt; alice = AttributeDict(name=&#39;alice&#39;, age=40, id=3, friends=l)</span>
<span class="sd">    &gt;&gt;&gt; alice.friends.name == [&#39;bob&#39;, &#39;tim&#39;]</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; alice[&#39;friends&#39;, 2] == tim</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; tim.friends = AttributeList([bob, alice])</span>
<span class="sd">    &gt;&gt;&gt; alice[&#39;friends&#39;, 2, &#39;friends&#39;, 3] == alice</span>
<span class="sd">    True</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="c1"># do not directly use self.__dict__</span>
        <span class="n">recursive</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__recursive__&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mapping__</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mapping__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__mapping__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">AttributeDict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__mapping__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">AttributeList</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid key </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                    <span class="k">break</span>
                <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="c1"># items: None | str | int</span>
        <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">items</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mapping__</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">items</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">items</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
                    <span class="c1"># get rid of some ipython magics</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mapping__</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Choose key from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Invalid key </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mapping__</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mapping__</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mapping__</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="fm">__getattr__</span> <span class="o">=</span> <span class="fm">__getitem__</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">attr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">AttributeDict</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__mapping__</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">attr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">AttributeDict</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__delattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__mapping__</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mapping__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__mapping__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">MutableMapping</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mapping__</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> at 0x</span><span class="si">%x</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typename</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mapping__</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__mapping__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">__mapping__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;__cls__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">memo</span><span class="p">:</span>
            <span class="n">memo</span><span class="p">[</span><span class="s1">&#39;__cls__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c1"># key may be tuple|int|string...(all hashable objects)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># value may be unhashable objects without a __deepcopy__ method</span>
                <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">memo</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">dct</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">memo</span><span class="p">[</span><span class="s1">&#39;__cls__&#39;</span><span class="p">](</span><span class="n">dct</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        A copy of self. Class of returned instance can be specified by the</span>
<span class="sd">        optional second argument `cls`, default current class.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; type(AttributeDict(a=1, b=2))</span>
<span class="sd">        embci.utils.AttributeDict</span>
<span class="sd">        &gt;&gt;&gt; type(AttributeDict(a=1, b=2).copy())</span>
<span class="sd">        embci.utils.AttributeDict</span>
<span class="sd">        &gt;&gt;&gt; type(AttributeDict(a=1, b=2).copy(dict))</span>
<span class="sd">        dict</span>
<span class="sd">        &gt;&gt;&gt; def generate_list(a, b):</span>
<span class="sd">                print(&#39;elements: &#39;, a, b)</span>
<span class="sd">                return [a, b]</span>
<span class="sd">        &gt;&gt;&gt; type(AttributeDict(a=1, b=2).copy(generate_list))</span>
<span class="sd">        elements: 1, 2</span>
<span class="sd">        [1, 2]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">cls</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">__mapping__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__deepcopy__</span><span class="p">({},</span> <span class="bp">cls</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="s1">&#39;D.get(k[,d]) -&gt; D[k] if k in D, else d.  d defaults to None.&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mapping__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mapping__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">AttributeList</span><span class="p">(</span><span class="n">MutableSequence</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get elements in list by attributes of them. It works much like a jQuery</span>
<span class="sd">    init list. In this list, elements with an `id` attribute can be selected</span>
<span class="sd">    by normal __getitem__ way.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; l = AttributeList([</span>
<span class="sd">        {&#39;name&#39;: &#39;bob&#39;, &#39;age&#39;: 16},</span>
<span class="sd">        {&#39;name&#39;: &#39;alice&#39;, &#39;age&#39;: 20},</span>
<span class="sd">        {&#39;name&#39;: &#39;tim&#39;, &#39;age&#39;: 22}</span>
<span class="sd">    ])</span>
<span class="sd">    &gt;&gt;&gt; l.name</span>
<span class="sd">    [&#39;bob&#39;, &#39;alice&#39;, &#39;tim&#39;]</span>
<span class="sd">    &gt;&gt;&gt; l.age</span>
<span class="sd">    [16, 20, 22]</span>

<span class="sd">    &gt;&gt;&gt; l2 = AttributeList([</span>
<span class="sd">        {&#39;id&#39;: 999, &#39;name&#39;: &#39;dot&#39;},</span>
<span class="sd">        {&#39;id&#39;: 1, &#39;name&#39;: &#39;line&#39;}</span>
<span class="sd">        {&#39;id&#39;: 2, &#39;name&#39;: &#39;rect&#39;}</span>
<span class="sd">    ])</span>
<span class="sd">    &gt;&gt;&gt; l2[999]</span>
<span class="sd">    {&#39;id&#39;: 999, &#39;name&#39;: &#39;dot&#39;}</span>
<span class="sd">    &gt;&gt;&gt; l2[0]  # if `id` selector failed, normal list indexing is used</span>
<span class="sd">    {&#39;id&#39;: 999, &#39;name&#39;: &#39;dot&#39;}</span>

<span class="sd">    &gt;&gt;&gt; l2[-2] == l2[1]  # minus number is regarded as index</span>
<span class="sd">    True</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="n">recursive</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__recursive__&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sequence__</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__sequence__</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__sequence__</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">AttributeList</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__sequence__</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">AttributeDict</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">AttributeList</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid index </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                    <span class="k">break</span>
                <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="c1"># items: None | -int | +int | slice</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">items</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">items</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>  <span class="c1"># this will call self.__getattr__(&#39;id&#39;)</span>
                    <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">items</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sequence__</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__sequence__</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Choose index from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Invalid index </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># unsupported type, like string | dict | tuple ...</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sequence__</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">index</span><span class="o">.</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sequence__</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sequence__</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sequence__</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sequence__</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__sequence__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sequence__</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sequence__</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sequence__</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> at 0x</span><span class="si">%x</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typename</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sequence__</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sequence__</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sequence__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">element</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">__sequence__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;__cls__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">memo</span><span class="p">:</span>
            <span class="n">memo</span><span class="p">[</span><span class="s1">&#39;__cls__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">memo</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">memo</span><span class="p">[</span><span class="s1">&#39;__cls__&#39;</span><span class="p">](</span><span class="n">lst</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Instance method to make a shallow or deep copy of self.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        AttributeDict.copy</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">cls</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">__sequence__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__deepcopy__</span><span class="p">({},</span> <span class="bp">cls</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BoolString</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create a real boolean string. Boolean table can be replaced.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    `bool(s)` will always return `True` if length of `s` is non-zero.</span>
<span class="sd">    This class is derived from `str` and make its instances real boolean.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; bool(BoolString(&#39;True&#39;))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; bool(BoolString(&#39;False&#39;))</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; bool(BoolString(&#39;Yes&#39;))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; bool(BoolString(&#39;Nop&#39;, table={&#39;Nop&#39;: False}))</span>
<span class="sd">    False</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">BOOLEAN_TABLE</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_boolean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>

    <span class="fm">__bool__</span> <span class="o">=</span> <span class="n">__nonzero__</span>


<span class="k">def</span> <span class="nf">timestamp</span><span class="p">(</span><span class="n">ctime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H:%M:%S&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">ctime</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">ensure_unicode</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    ensure_unicode(s0, s1, ..., sn) ==&gt; (u0, u1, ..., un)</span>

<span class="sd">    In python version prior to 3.0:</span>
<span class="sd">          object</span>
<span class="sd">            |</span>
<span class="sd">            |</span>
<span class="sd">        basestring</span>
<span class="sd">           /   \\</span>
<span class="sd">          /     \\</span>
<span class="sd">        str[1] unicode</span>
<span class="sd">    str: 8-bits 0-255 char string</span>
<span class="sd">    unicode: represent any char in any alphabet heading with u&#39;&#39;</span>

<span class="sd">    In python3:</span>
<span class="sd">          object</span>
<span class="sd">           /  \\</span>
<span class="sd">          /    \\</span>
<span class="sd">        bytes  str</span>
<span class="sd">    bytes: 8-bits 0-255 char string heading with b&#39;&#39;</span>
<span class="sd">    str: unicode string</span>

<span class="sd">    Reference: 1. `bytes` is an alias of str in python2(bytes &lt;==&gt; str)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">allstr</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;cannot convert non-string type &#39;</span>
                            <span class="s1">&#39;`</span><span class="si">%s</span><span class="s1">` to unicode&#39;</span> <span class="o">%</span> <span class="n">typename</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>     <span class="c1"># py2 str or py3 bytes</span>
            <span class="n">a</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>  <span class="c1"># py2 unicode or py3 str</span>
            <span class="c1"># a[n] = u&#39;{}&#39;.format(a[n])</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">ensure_bytes</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">allstr</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;cannot convert non-string type &#39;</span>
                            <span class="s1">&#39;`</span><span class="si">%s</span><span class="s1">` to bytes&#39;</span> <span class="o">%</span> <span class="n">typename</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>  <span class="c1"># py2 unicode or py3 str</span>
            <span class="n">a</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>   <span class="c1"># py2 str or py3 bytes</span>
            <span class="c1"># a[n] = b&#39;{}&#39;.format(a[n])</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">format_size</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Turn number of bytes into human-readable str. Bytes are abbrivated in</span>
<span class="sd">    upper case, while bits use lower case. Only keyword arguments are accepted</span>
<span class="sd">    because any positional arguments will be regarded as a size in bytes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    units : array of str</span>
<span class="sd">        Default &#39;Bytes&#39;, &#39;KB&#39;, &#39;MB&#39;, &#39;GB&#39;, &#39;TB&#39;, &#39;PB&#39;.</span>
<span class="sd">    decimals : array of int</span>
<span class="sd">        Default 0, 1, 2, 2, 2, 2. Estimated result: 10 Bytes, 1.0 KB, 1.12 MB,</span>
<span class="sd">        1.23 GB, 1.34 TB, 1.45 PB.</span>
<span class="sd">    base : int</span>
<span class="sd">        Default 1024, can be set to 1000.</span>
<span class="sd">    inbits : bool</span>
<span class="sd">        Whether convert output to bits.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; format_size(2**10 - 1)</span>
<span class="sd">    u&#39;1023 B&#39;</span>
<span class="sd">    &gt;&gt;&gt; format_size(2**10)</span>
<span class="sd">    u&#39;1.0 KB&#39;</span>
<span class="sd">    &gt;&gt;&gt; format_size(1024 * 1024, base=1000, decimals=10)</span>
<span class="sd">    u&#39;1.048576 MB&#39;</span>
<span class="sd">    &gt;&gt;&gt; format_size(2**30, inbits=True)</span>
<span class="sd">    u&#39;8.00 Gb&#39;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
    <span class="n">inbits</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;inbits&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">units</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;Kb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mb&#39;</span><span class="p">,</span> <span class="s1">&#39;Gb&#39;</span><span class="p">,</span> <span class="s1">&#39;Tb&#39;</span><span class="p">,</span> <span class="s1">&#39;Pb&#39;</span>
    <span class="p">]</span> <span class="k">if</span> <span class="n">inbits</span> <span class="k">else</span> <span class="p">[</span>
        <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;KB&#39;</span><span class="p">,</span> <span class="s1">&#39;MB&#39;</span><span class="p">,</span> <span class="s1">&#39;GB&#39;</span><span class="p">,</span> <span class="s1">&#39;TB&#39;</span><span class="p">,</span> <span class="s1">&#39;PB&#39;</span>
    <span class="p">])</span>
    <span class="n">decimals</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;decimals&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="mi">0</span><span class="p">,</span>   <span class="mi">3</span><span class="p">,</span>    <span class="mi">4</span><span class="p">,</span>    <span class="mi">4</span><span class="p">,</span>    <span class="mi">4</span><span class="p">,</span>    <span class="mi">7</span>
    <span class="p">]</span> <span class="k">if</span> <span class="n">inbits</span> <span class="k">else</span> <span class="p">[</span>
        <span class="mi">0</span><span class="p">,</span>   <span class="mi">1</span><span class="p">,</span>    <span class="mi">2</span><span class="p">,</span>    <span class="mi">2</span><span class="p">,</span>    <span class="mi">2</span><span class="p">,</span>    <span class="mi">4</span>
    <span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">decimals</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="n">decimals</span> <span class="o">=</span> <span class="p">[</span><span class="n">decimals</span><span class="p">,</span> <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>

    <span class="n">a</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">a</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0 Byte&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inbits</span><span class="p">:</span>
                <span class="n">num</span> <span class="o">*=</span> <span class="mi">8</span>
            <span class="n">exponent</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">base</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">a</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;{:.</span><span class="si">%s</span><span class="s1">f} </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">decimals</span><span class="p">[</span><span class="n">exponent</span><span class="p">])</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">num</span> <span class="o">/</span> <span class="p">(</span><span class="n">base</span> <span class="o">**</span> <span class="n">exponent</span><span class="p">),</span> <span class="n">units</span><span class="p">[</span><span class="n">exponent</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">a</span>


<span class="k">def</span> <span class="nf">get_boolean</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">constants</span><span class="o">.</span><span class="n">BOOLEAN_TABLE</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;convert string to boolean&#39;&#39;&#39;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid boolean value: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">table</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">typename</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>


<span class="k">def</span> <span class="nf">random_id</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="o">+</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Generate a random ID composed of digits and lower ASCII characters.&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">)])</span>


<span class="k">def</span> <span class="nf">validate_filename</span><span class="p">(</span><span class="o">*</span><span class="n">fns</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Validate inputted filename according to system.&#39;&#39;&#39;</span>
    <span class="n">fns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fns</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fns</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="n">char</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">fn</span>
            <span class="k">if</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">VALID_FILENAME_CHARACTERS</span>
        <span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Linux&#39;</span><span class="p">,</span> <span class="s1">&#39;Java&#39;</span><span class="p">]</span> <span class="ow">and</span>
            <span class="n">name</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">INVALID_FILENAMES_UNIX</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span> <span class="ow">and</span>
            <span class="n">name</span> <span class="ow">in</span> <span class="n">constants</span><span class="o">.</span><span class="n">INVALID_FILENAMES_WIN</span>
        <span class="p">):</span>
            <span class="n">fns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">return</span> <span class="n">fns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">fns</span>


<span class="k">def</span> <span class="nf">load_configs</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">fns</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Read configuration files and return an AttributeDict.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    This function accepts arbitrary arugments, i.e.:</span>
<span class="sd">        - one or more filenames</span>
<span class="sd">        - one list of filenames</span>
<span class="sd">    &gt;&gt;&gt; load_configs(&#39;~/.embci/embci.conf&#39;)</span>
<span class="sd">    &gt;&gt;&gt; load_configs(&#39;/etc/embci.conf&#39;, &#39;~/.embci/embci.conf&#39;, &#39;no-exist&#39;)</span>
<span class="sd">    &gt;&gt;&gt; load_configs([&#39;/etc/embci.conf&#39;, &#39;~/.embci/embci.conf&#39;], &#39;no-exist&#39;)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Configurations priority(from low to high)::</span>
<span class="sd">        On Unix-like system:</span>
<span class="sd">            project config file: &quot;${EmBCI}/files/service/embci.conf&quot;</span>
<span class="sd">             system config file: &quot;/etc/embci/embci.conf&quot;</span>
<span class="sd">               user config file: &quot;~/.embci/embci.conf&quot;</span>
<span class="sd">        On Windows system:</span>
<span class="sd">            project config file: &quot;${EmBCI}/files/service/embci.conf&quot;</span>
<span class="sd">             system config file: &quot;${APPDATA}/embci.conf&quot;</span>
<span class="sd">               user config file: &quot;${USERPROFILE}/.embci/embci.conf&quot;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">optionxform</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="p">[</span><span class="n">fn</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">fns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
    <span class="p">]</span> <span class="ow">or</span> <span class="n">configs</span><span class="o">.</span><span class="n">DEFAULT_CONFIG_FILES</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;loading config file: `</span><span class="si">%s</span><span class="s1">`&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Cannot load config file: `</span><span class="si">%s</span><span class="s1">`&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
    <span class="c1"># for python2 &amp; 3 compatibility, use config.items and config.sections</span>
    <span class="k">return</span> <span class="n">AttributeDict</span><span class="p">({</span>
        <span class="n">section</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">()</span>
    <span class="p">})</span>


<span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">configfiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get configurations from environment variables or config files.</span>
<span class="sd">    EmBCI use `INI-Style &lt;https://en.wikipedia.org/wiki/INI_file&gt;`_</span>
<span class="sd">    configuration files with extention of `.conf`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key : str</span>
<span class="sd">    default : optional</span>
<span class="sd">        Return `default` if key is not in configuration files or environ,</span>
<span class="sd">    type : function | class | None, optional</span>
<span class="sd">        Convert function to be applied on the result, such as int or bool.</span>
<span class="sd">    configfiles : str | list of str, optional</span>
<span class="sd">        Configuration filenames.</span>
<span class="sd">    section : str | None, optional</span>
<span class="sd">        Section to search for key. Default None, search for each section.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Configuration resolving priority (from low to high):</span>
<span class="sd">    - system configuration files (loaded in embci.configs)</span>
<span class="sd">    - specified configuration file[s] (by argument `configfiles`)</span>
<span class="sd">    - environment variables (os.environ)</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    `configparser &lt;https://en.wikipedia.org/wiki/INI_file&gt;`_</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">configs</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">configfiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">load_configs</span><span class="p">(</span><span class="n">configfiles</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">section</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="p">{}):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">Singleton</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Singleton metaclass</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; class Test(object):  # py2 &amp; py3</span>
<span class="sd">            __metaclass__ = Singleton</span>
<span class="sd">            def __init__(self, *a, **k):</span>
<span class="sd">                self.args = a</span>
<span class="sd">                self.kwargs = k</span>

<span class="sd">    &gt;&gt;&gt; class Test(object, metaclass=Singleton):  # py3 only</span>
<span class="sd">            pass</span>

<span class="sd">    &gt;&gt;&gt; Test()</span>
<span class="sd">    &lt;__main__.Test at 0x7f3e09e99390&gt;</span>
<span class="sd">    &gt;&gt;&gt; Test()</span>
<span class="sd">    &lt;__main__.Test at 0x7f3e09e99390&gt;</span>
<span class="sd">    &gt;&gt;&gt; Test() == Test() == _</span>
<span class="sd">    True</span>

<span class="sd">    Instance can be re-initalized by providing argument `reinit`:</span>
<span class="sd">    &gt;&gt;&gt; Test(1, 2, 3).args</span>
<span class="sd">    (1, 2, 3)</span>
<span class="sd">    &gt;&gt;&gt; Test(2, 3, 4).args</span>
<span class="sd">    (1, 2, 3)</span>
<span class="sd">    &gt;&gt;&gt; vars(Test(2, 3, 4, reinit=True, verbose=logging.INFO))</span>
<span class="sd">    {&#39;args&#39;: (2, 3, 4), &#39;kwargs&#39;: {&#39;verbose&#39;: 20}}</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">__instances__</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cls_name</span><span class="p">,</span> <span class="n">cls_bases</span><span class="p">,</span> <span class="n">cls_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="c1"># Returned class&#39;s __call__ method will be overwritten by</span>
        <span class="c1"># cls.__call__ if it&#39;s a subclass of this metaclass.</span>
        <span class="k">return</span> <span class="nb">type</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cls_name</span><span class="p">,</span> <span class="n">cls_bases</span><span class="p">,</span> <span class="n">cls_dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__instances__</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">__instances__</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Singleton</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;reinit&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">__instances__</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__instances__</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">__instances__</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__instances__</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">__instances__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Decorators</span>

<span class="k">class</span> <span class="nc">LockedFile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Context manager for creating temp &amp; auto-recycled &amp; locked files</span>

<span class="sd">    Here&#39;s something to be decleared on locking a file:</span>
<span class="sd">    1. fcntl.lockf() most of the time implemented as a wrapper around the</span>
<span class="sd">       fcntl() locking calls, which bound to processes, not file descriptors.</span>
<span class="sd">    2. fcntl.flock() locks are bound to file descriptors, not processes.</span>
<span class="sd">    3. On at least some systems, fcntl.LOCK_EX can only be used if the file</span>
<span class="sd">       descriptor refers to a file opened for writing.</span>
<span class="sd">    4. fcntl locks will be released after file is closed or by fcntl.LOCK_UN.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create file directory if not exists.</span>
<span class="sd">        Write current process&#39;s id to file if it&#39;s used as a PIDFILE.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span> <span class="ow">or</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mktemp</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">k</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;autoclean&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">k</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;pidfile&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Lock the file object with fcntl.flock&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mo">0o775</span><span class="p">)</span>
            <span class="c1">#  self.file_obj = os.fdopen(</span>
            <span class="c1">#      os.open(self.path, os.O_CREAT | os.O_RDWR))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;a+&#39;</span><span class="p">)</span>  <span class="c1"># &#39;a&#39; will not truncate file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fcntl</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_EX</span> <span class="o">|</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_NB</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;file `</span><span class="si">%s</span><span class="s1">` has been used!&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pidfile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span>

    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1">#  if not self.file_obj.closed:</span>
        <span class="c1">#      fcntl.flock(self.file_obj, fcntl.LOCK_UN)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoclean</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Locked file `</span><span class="si">%s</span><span class="s1">` removed.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="fm">__enter__</span> <span class="o">=</span> <span class="n">acquire</span>
    <span class="fm">__exit__</span>  <span class="o">=</span> <span class="n">release</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">{}</span><span class="s1">(</span><span class="si">{}</span><span class="s1">locked) </span><span class="si">{}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">typename</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="s1">&#39;un&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Ensure file released when garbage collection of instance.&#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">pass</span>


<span class="k">class</span> <span class="nc">TempStream</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Context manager to temporarily mask streams like stdout/stderr/stdin.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    You can redirect standard output to a file just like shell command</span>
<span class="sd">    `$ python test.py &gt; /var/log/foo.log`:</span>

<span class="sd">    &gt;&gt;&gt; with TempStream(stdout=&#39;/var/log/foo.log&#39;):</span>
<span class="sd">            print(&#39;bar&#39;, file=sys.stdout)</span>
<span class="sd">    &gt;&gt;&gt; open(&#39;var/log/foo.log&#39;).read()</span>
<span class="sd">    bar</span>

<span class="sd">    If no target stream (file-like object) specified, a StringIO buffer is</span>
<span class="sd">    used to collect message from origin stream. All string from buffers will</span>
<span class="sd">    be saved in an AttributeDict and returned for easier usage.</span>

<span class="sd">    &gt;&gt;&gt; # mask stdout and stderr to a string buffer</span>
<span class="sd">    &gt;&gt;&gt; with TempStream(&#39;stdout&#39;, &#39;stderr&#39;) as ts:</span>
<span class="sd">            print(&#39;hello&#39;, file=sys.stdout, end=&#39;&#39;)</span>
<span class="sd">            print(&#39;error&#39;, file=sys.stderr)</span>
<span class="sd">    &gt;&gt;&gt; type(ts)</span>
<span class="sd">    embci.utils.AttributeDict</span>
<span class="sd">    &gt;&gt;&gt; str(ts)</span>
<span class="sd">    &quot;{&#39;stderr&#39;: &#39;error\\n&#39;, &#39;stdout&#39;: &#39;hello&#39;}&quot;</span>
<span class="sd">    &gt;&gt;&gt; ts.stdout + &#39; &#39; + ts[&#39;stderr&#39;]</span>
<span class="sd">    &#39;hello error\n&#39;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">_disabled</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_target</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;stdout&#39;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
        <span class="s1">&#39;stderr&#39;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
        <span class="s1">&#39;stdin&#39;</span><span class="p">:</span>  <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_replace</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_savepos</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_message</span> <span class="o">=</span> <span class="n">AttributeDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">stream</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;stdout&#39;</span><span class="p">,</span> <span class="s1">&#39;stderr&#39;</span><span class="p">,</span> <span class="s1">&#39;stdin&#39;</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid stream name: `</span><span class="si">{}</span><span class="s1">`&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">stream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
                <span class="n">stream</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid stream: `</span><span class="si">{}</span><span class="s1">`&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_replace</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">stream</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_savepos</span><span class="p">[</span><span class="n">stream</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">enable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disabled</span><span class="p">,</span> <span class="s1">&#39;Cannot re-enable a disabled TempStream&#39;</span>
        <span class="c1"># replace origin streams with new streams</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">stream</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replace</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message</span>

    <span class="k">def</span> <span class="nf">disable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">stream</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replace</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># recover origin stream</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="c1"># check if new stream is one of origins</span>
            <span class="k">if</span> <span class="n">stream</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="c1"># fetch message as string from new streams</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_message</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_string</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disabled</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Current stream position is saved so that next time it will read from</span>
<span class="sd">        where it left this time without cleaning.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">stream</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replace</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_message</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_string</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message</span>
        <span class="k">elif</span> <span class="n">stream</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replace</span><span class="p">:</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replace</span><span class="p">[</span><span class="n">stream</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">stream</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replace</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Not masked stream: `</span><span class="si">{}</span><span class="s1">`&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream</span><span class="p">))</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="c1"># Get current cursor position</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="c1"># Move cursor to last position</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_savepos</span><span class="p">[</span><span class="n">stream</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">clean</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1"># Default it will not clean the buffer</span>
        <span class="k">if</span> <span class="n">clean</span><span class="p">:</span>
            <span class="n">stream</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_savepos</span><span class="p">[</span><span class="n">stream</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="k">return</span> <span class="n">msg</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">disable_all</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_disabled</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="fm">__enter__</span> <span class="o">=</span> <span class="n">enable</span>
    <span class="fm">__exit__</span> <span class="o">=</span> <span class="n">disable</span>


<span class="k">class</span> <span class="nc">CachedProperty</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Descriptor class to construct a property that is only computed once and</span>
<span class="sd">    then replaces itself as an ordinary attribute. Deleting the attribute</span>
<span class="sd">    resets the property.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;__doc__&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__func</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__name</span><span class="p">)</span>


<span class="nd">@decorator</span>
<span class="k">def</span> <span class="nf">verbose</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Add support to any callable functions or methods to change verbose level</span>
<span class="sd">    by specifying keyword argument `verbose=&#39;LEVEL&#39;`.</span>

<span class="sd">    Verbose level can be int or bool or one of `logging` defined string</span>
<span class="sd">    [&#39;NOTSET&#39;, &#39;DEBUG&#39;, &#39;INFO&#39;, &#39;WARNING&#39;, &#39;ERROR&#39;, &#39;CRITICAL&#39;]</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; @verbose</span>
<span class="sd">    ... def echo(s):</span>
<span class="sd">    ...     logger.info(s)</span>
<span class="sd">    &gt;&gt;&gt; echo(&#39;set log level to warning&#39;, verbose=&#39;WARN&#39;)</span>
<span class="sd">    &gt;&gt;&gt; echo(&#39;set log level to debug&#39;, verbose=&#39;DEBUG&#39;)</span>
<span class="sd">    set log level to debug</span>
<span class="sd">    &gt;&gt;&gt; echo(&#39;mute message&#39;, verbose=False)  # equals to verbose=ERROR</span>
<span class="sd">    &gt;&gt;&gt; echo(&#39;max verbose&#39;, verbose=True)    # equals to verbose=NOTSET</span>
<span class="sd">    max verbose</span>
<span class="sd">    &gt;&gt;&gt; echo(&#39;default level&#39;, verbose=None)  # do not change verbose level</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Verbose level may comes from ways listed below (sorted by prority),</span>
<span class="sd">    which also means this function can be used under these situations.</span>

<span class="sd">    1. class default verbosity</span>
<span class="sd">    &gt;&gt;&gt; class Testing(object):</span>
<span class="sd">    ...     def __init__(self):</span>
<span class="sd">    ...         self.verbose = &#39;INFO&#39;</span>
<span class="sd">    ...     @verbose</span>
<span class="sd">    ...     def echo(self, s, verbose=None):</span>
<span class="sd">    ...         # verbose = verbose or self.verbose</span>
<span class="sd">    ...         logger.info(s)</span>

<span class="sd">    2. default argument</span>
<span class="sd">    &gt;&gt;&gt; @verbose</span>
<span class="sd">        def echo(s, verbose=True):</span>
<span class="sd">            logger.info(s)</span>
<span class="sd">    &gt;&gt;&gt; echo(&#39;hello&#39;)</span>
<span class="sd">    hello</span>

<span class="sd">    3. positional argument</span>
<span class="sd">    &gt;&gt;&gt; echo(&#39;hello&#39;, None)</span>

<span class="sd">    4. keyword argument</span>
<span class="sd">    &gt;&gt;&gt; echo(&#39;hello&#39;, verbose=False)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">level</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">argnames</span><span class="p">,</span> <span class="n">defaults</span> <span class="o">=</span> <span class="n">get_func_args</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argnames</span><span class="p">)</span> <span class="ow">and</span> <span class="n">argnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="s1">&#39;cls&#39;</span><span class="p">):</span>
        <span class="n">level</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>                <span class="c1"># situation 1</span>
    <span class="k">if</span> <span class="s1">&#39;verbose&#39;</span> <span class="ow">in</span> <span class="n">argnames</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">argnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">argnames</span><span class="p">)]</span>                 <span class="c1"># situation 2</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># default not defined in function</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>                                     <span class="c1"># situation 3</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># verbose not provided by user</span>
    <span class="n">level</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>                          <span class="c1"># situation 4</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">level</span> <span class="o">=</span> <span class="s1">&#39;ERROR&#39;</span> <span class="k">if</span> <span class="n">level</span> <span class="k">else</span> <span class="s1">&#39;NOTSET&#39;</span>
    <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">TempLogLevel</span><span class="p">(</span><span class="n">level</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">duration</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">warning</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Want to looply execute some function every specific time duration?</span>
<span class="sd">    You may use this deocrator factory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sec : int</span>
<span class="sd">        Minimum duration of executing function in seconds.</span>
<span class="sd">    name : str, optional</span>
<span class="sd">        Identify task name. Default use id(function).</span>
<span class="sd">    warning : str, optional</span>
<span class="sd">        Warn message to display if function is called too frequently.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; @duration(3, &#39;__main__.testing&#39;, warning=&#39;cant call so frequently!&#39;)</span>
<span class="sd">    ... def testing(s):</span>
<span class="sd">    ...     print(&#39;time: %.1fs, %s&#39; % (time.clock(), s))</span>

<span class="sd">    &gt;&gt;&gt; while 1:</span>
<span class="sd">    ...     time.sleep(1)</span>
<span class="sd">    ...     testing(&#39;now you are executing testing function&#39;)</span>
<span class="sd">    ...</span>
<span class="sd">    time: 32.2s, now you are executing testing function</span>
<span class="sd">    cant call so frequently! # time: 33.2s</span>
<span class="sd">    cant call so frequently! # time: 34.2s</span>
<span class="sd">    time: 35.2s, now you are executing testing function</span>
<span class="sd">    cant call so frequently! # time: 36.2s</span>
<span class="sd">    cant call so frequently! # time: 37.2s</span>
<span class="sd">    ...</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">time_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@decorator</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">_name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="nb">id</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">time_dict</span><span class="p">:</span>
            <span class="n">time_dict</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time_dict</span><span class="p">[</span><span class="n">_name</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">sec</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">warning</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time_dict</span><span class="p">[</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># I/O</span>

<span class="c1">#  class TimeoutException(TimeoutError):  # py3 only, use this after 2020.1.1</span>
<span class="k">class</span> <span class="nc">TimeoutException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">sec</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Timeout</span><span class="si">{timeout}{message}{source}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sec</span> <span class="ow">and</span> <span class="s1">&#39;(</span><span class="si">{}</span><span class="s1">s)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sec</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="ow">and</span> <span class="s1">&#39;: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">source</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="ow">and</span> <span class="s1">&#39; within `</span><span class="si">%s</span><span class="s1">`.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">input</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flist</span><span class="o">=</span><span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">]):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    input([prompt[, timeout[, flist]]]) -&gt; string</span>

<span class="sd">    Read from a list of file-like objects (default only from sys.stdin)</span>
<span class="sd">    and return raw string as python2 function `raw_input` do.</span>

<span class="sd">    The optional second argument specifies a timeout in seconds. Both int</span>
<span class="sd">    and float is accepted. If timeout, an error will be thrown out.</span>

<span class="sd">    This function is PY2/3 &amp; Linux/Windows compatible (On Windows, only</span>
<span class="sd">    sockets are supported; on Unix, all file descriptors can be used.)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#  if os.name == &#39;nt&#39;:</span>
    <span class="c1">#      from builtins import input</span>
    <span class="c1">#      return input(prompt)</span>

    <span class="k">if</span> <span class="n">prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flist</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="n">flist</span> <span class="o">=</span> <span class="p">[</span><span class="n">flist</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rlist</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">flist</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="n">timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">select</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
        <span class="n">rlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">KeyboardInterrupt</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rlist</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;read from </span><span class="si">{}</span><span class="s1"> failed&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">flist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">flist</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">TimeoutException</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="s1">&#39;embci.utils.input&#39;</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">rlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">rlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;readline&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;recv&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">method</span><span class="p">)()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Cannot read from `</span><span class="si">%s</span><span class="s1">`&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_input</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">answer</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function is to guide user make choices.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; check_input(&#39;This will call pip and try install pycnbi. [Y/n] &#39;,</span>
<span class="sd">                    {&#39;y&#39;: True, &#39;n&#39;: False})</span>
<span class="sd">    [1/3] This will call pip and try install pycnbi. [Y/n] 123</span>
<span class="sd">    Invalid input `123`! Choose from [ y | n ]</span>
<span class="sd">    [2/3] This will call pip and try install pycnbi. [Y/n] y</span>
<span class="sd">    # return True</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">answer</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">times</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rst</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">] &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span> <span class="o">+</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">/</span> <span class="n">times</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">TimeoutException</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rst</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;nothing read, confirm? ([Y]/n) &#39;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">return</span> <span class="n">rst</span>
        <span class="k">elif</span> <span class="n">rst</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">answer</span><span class="p">[</span><span class="n">rst</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid input `</span><span class="si">%s</span><span class="s1">`! Choose from [ </span><span class="si">%s</span><span class="s1"> ]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rst</span><span class="p">,</span> <span class="s1">&#39; | &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span>


<span class="k">def</span> <span class="nf">mkuserdir</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Create user folder at ${DIR_DATA}/${username} if it doesn&#39;t exists.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    When used as a decorator, it will automatically detect arguments of wrapped</span>
<span class="sd">    function to get the specified `username` argument and create its folder.</span>
<span class="sd">    &gt;&gt;&gt; @mkuserdir</span>
<span class="sd">    ... def save_user_data(username):</span>
<span class="sd">    ...     path = os.path.join(DIR_DATA, username, &#39;data-1.csv&#39;)</span>
<span class="sd">    ...     write_data_to_csv(path, data)</span>
<span class="sd">    &gt;&gt;&gt; save_user_data(&#39;bob&#39;)   # folder ${DIR_DATA}/bob is already created</span>
<span class="sd">    &gt;&gt;&gt; save_user_data(&#39;jack&#39;)  # write_data_to_csv don&#39;t need to care this</span>

<span class="sd">    Or use it with username directly:</span>
<span class="sd">    &gt;&gt;&gt; mkuserdir(&#39;john&#39;)</span>
<span class="sd">    &gt;&gt;&gt; os.listdir(DIR_DATA)</span>
<span class="sd">    [&#39;example&#39;, &#39;bob&#39;, &#39;jack&#39;, &#39;john&#39;]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">param_collector</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">string_types</span><span class="p">):</span>
                <span class="n">username</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">username</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mkuserdir</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;Username is not detected, `</span><span class="si">%s</span><span class="s1">` decorator abort.&#39;</span> <span class="o">%</span> <span class="n">func</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">or</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;args: </span><span class="si">{}</span><span class="s1">, kwargs: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>
        <span class="n">param_collector</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span>
        <span class="k">return</span> <span class="n">param_collector</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">ensure_unicode</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configs</span><span class="o">.</span><span class="n">DIR_DATA</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;User </span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">s folder at </span><span class="si">%s</span><span class="s1"> exist,&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mo">0o775</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;User </span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">s folder at </span><span class="si">%s</span><span class="s1"> created.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
        <span class="k">return</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;function or string wanted, but got `</span><span class="si">%s</span><span class="s1">`&#39;</span> <span class="o">%</span> <span class="n">typename</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>


<span class="nd">@verbose</span>
<span class="k">def</span> <span class="nf">virtual_serial</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generate a pair of virtual serial port at /dev/pts/*.</span>
<span class="sd">    Super useful when debugging without a real UART device.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    verbose : bool | int</span>
<span class="sd">        Logging level or boolean specifying whether print serial I/O data</span>
<span class="sd">        count infomation to terminal. Default logging.INFO.</span>
<span class="sd">    timeout : int</span>
<span class="sd">        Virtual serial connection will auto-break to save system resources</span>
<span class="sd">        after waiting until timeout. -1 specifying never timeout. Default is</span>
<span class="sd">        120 seconds (2 mins).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    flag_close : threading.Event</span>
<span class="sd">        Set flag by `flag_close.set` to manually terminate the virtual</span>
<span class="sd">        serial connection.</span>
<span class="sd">    port1 : str</span>
<span class="sd">        Master serial port.</span>
<span class="sd">    port2 : str</span>
<span class="sd">        Slave serial port.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; flag = virtual_serial(timeout=-1)[0]</span>

<span class="sd">    Suppose it&#39;s /dev/pts/0 &lt;==&gt; /dev/pts/1</span>
<span class="sd">    &gt;&gt;&gt; s = serial.Serial(&#39;/dev/pts/1&#39;,115200)</span>
<span class="sd">    &gt;&gt;&gt; m = serial.Serial(&#39;/dev/pts/0&#39;,115200)</span>
<span class="sd">    &gt;&gt;&gt; s.write(&#39;hello?\\n&#39;)</span>
<span class="sd">    7</span>
<span class="sd">    &gt;&gt;&gt; m.read_until()</span>
<span class="sd">    &#39;hello?\\n&#39;</span>
<span class="sd">    &gt;&gt;&gt; flag.set()</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">master1</span><span class="p">,</span> <span class="n">slave1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">openpty</span><span class="p">()</span>
    <span class="n">master2</span><span class="p">,</span> <span class="n">slave2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">openpty</span><span class="p">()</span>
    <span class="n">port1</span><span class="p">,</span> <span class="n">port2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">ttyname</span><span class="p">(</span><span class="n">slave1</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">ttyname</span><span class="p">(</span><span class="n">slave2</span><span class="p">)</span>
    <span class="c1"># RX1 TX1 RX2 TX2 counter</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[Visual Serial] Pty opened!&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Port1: </span><span class="si">%s</span><span class="se">\t</span><span class="s1">Port2: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">port1</span><span class="p">,</span> <span class="n">port2</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">echo</span><span class="p">(</span><span class="n">flag_close</span><span class="p">):</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">flag_close</span><span class="o">.</span><span class="n">isSet</span><span class="p">():</span>
            <span class="n">rlist</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">master1</span><span class="p">,</span> <span class="n">master2</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rlist</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">master</span> <span class="ow">in</span> <span class="n">rlist</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">master</span> <span class="o">==</span> <span class="n">master1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">{}</span><span class="s1"> --&gt; </span><span class="si">{}</span><span class="s1">] </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port1</span><span class="p">,</span> <span class="n">port2</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
                    <span class="n">count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">count</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">master2</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">master</span> <span class="o">==</span> <span class="n">master2</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">{}</span><span class="s1"> --&gt; </span><span class="si">{}</span><span class="s1">] </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port2</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
                    <span class="n">count</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">master1</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">RX1: </span><span class="si">%s</span><span class="se">\t</span><span class="s1">TX1: </span><span class="si">%s</span><span class="se">\t</span><span class="s1">RX2: </span><span class="si">%s</span><span class="se">\t</span><span class="s1">TX2: </span><span class="si">%s</span><span class="s1">&#39;</span>
                         <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">format_size</span><span class="p">(</span><span class="o">*</span><span class="n">count</span><span class="p">)))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[Virtual Serial] shutdown...&#39;</span><span class="p">)</span>
    <span class="n">flag_close</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">echo</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">flag_close</span><span class="p">,))</span>
    <span class="n">t</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">killer</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">:</span> <span class="n">flag_close</span><span class="o">.</span><span class="n">set</span><span class="p">())</span>
        <span class="n">killer</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">killer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">flag_close</span><span class="p">,</span> <span class="n">port1</span><span class="p">,</span> <span class="n">port2</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Local Modules</span>

<span class="kn">from</span> <span class="nn">._looptask</span> <span class="k">import</span> <span class="o">*</span>                                           <span class="c1"># noqa: W401</span>

<span class="kn">from</span> <span class="nn">._logging</span> <span class="k">import</span> <span class="o">*</span>                                            <span class="c1"># noqa: W401</span>
<span class="kn">from</span> <span class="nn">._logging</span> <span class="k">import</span> <span class="n">TempLogLevel</span><span class="p">,</span> <span class="n">config_logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">config_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">addhdlr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">._resolve</span> <span class="k">import</span> <span class="o">*</span>                                            <span class="c1"># noqa: W401</span>
<span class="kn">from</span> <span class="nn">._resolve</span> <span class="k">import</span> <span class="n">get_func_args</span><span class="p">,</span> <span class="n">get_caller_globals</span>

<span class="kn">from</span> <span class="nn">._json</span> <span class="k">import</span> <span class="o">*</span>                                               <span class="c1"># noqa: W401</span>

<span class="kn">from</span> <span class="nn">._event</span> <span class="k">import</span> <span class="o">*</span>                                              <span class="c1"># noqa: W401</span>

<span class="c1"># THE END</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2019, Hankso and individual contributors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>