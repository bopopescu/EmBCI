

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>embci.io.readers &mdash; EmBCI v0.2.3 User Guide</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../../',
              VERSION:'0.2.3',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> EmBCI
          

          
          </a>

          
            
            
              <div class="version">
                0.2.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme_zh.html">Get Started 中文</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../hardware/index.html">Hardware Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apis/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../service.html">Linux Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../update.html">Updating</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Configurations.html">Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Copyrights.html">Copyrights</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../TODO.html">TODOs</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">EmBCI</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>embci.io.readers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for embci.io.readers</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># coding=utf-8</span>
<span class="c1">#</span>
<span class="c1"># File: EmBCI/embci/io/readers.py</span>
<span class="c1"># Authors: Hank &lt;hankso1106@gmail.com&gt;</span>
<span class="c1"># Create: 2018-03-06 20:48:40</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Readers represent data streams that can be started, paused, resumed and closed.</span>
<span class="sd">The source of streams can be various, for example:</span>
<span class="sd">    - Local files (.csv, .mat, .fif, etc.)</span>
<span class="sd">    - Network TCP/UDP sockets</span>
<span class="sd">    - Hardware interfaces like UART(serials) and SPI</span>
<span class="sd">    - Lab-streaming-layer (LSL)</span>
<span class="sd">    - Or even randomly generated data</span>

<span class="sd">Known bugs:</span>
<span class="sd">    1. It&#39;s not suggested to use some API across multiprocessing because the</span>
<span class="sd">    underlying codes may register some value/attribute/configs on specific</span>
<span class="sd">    process. For example, a LSL inlet cannot be used in different processes.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="c1"># built-in</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">mmap</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="k">import</span> <span class="n">c_bool</span><span class="p">,</span> <span class="n">c_char_p</span><span class="p">,</span> <span class="n">c_uint8</span><span class="p">,</span> <span class="n">c_uint16</span><span class="p">,</span> <span class="n">c_float</span>

<span class="c1"># requirements.txt: data: numpy, scipy, pylsl</span>
<span class="c1"># requirements.txt: drivers: pyserial</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.io</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span>
<span class="kn">import</span> <span class="nn">pylsl</span>
<span class="kn">import</span> <span class="nn">serial</span>

<span class="kn">from</span> <span class="nn">..utils</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ensure_unicode</span><span class="p">,</span> <span class="n">ensure_bytes</span><span class="p">,</span> <span class="n">get_boolean</span><span class="p">,</span> <span class="n">format_size</span><span class="p">,</span>
    <span class="n">validate_filename</span><span class="p">,</span> <span class="n">random_id</span><span class="p">,</span> <span class="n">check_input</span><span class="p">,</span>
    <span class="n">find_serial_ports</span><span class="p">,</span> <span class="n">find_pylsl_outlets</span><span class="p">,</span> <span class="n">find_spi_devices</span><span class="p">,</span>
    <span class="n">LockedFile</span><span class="p">,</span> <span class="n">Singleton</span><span class="p">,</span> <span class="n">LoopTaskMixin</span><span class="p">,</span> <span class="n">SkipIteration</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">..drivers.ads1299</span> <span class="k">import</span> <span class="n">ADS1299_API</span>
<span class="kn">from</span> <span class="nn">..drivers.esp32</span> <span class="k">import</span> <span class="n">ESP32_API</span>
<span class="kn">from</span> <span class="nn">..configs</span> <span class="k">import</span> <span class="n">DIR_PID</span><span class="p">,</span> <span class="n">DIR_TMP</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">logger</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;validate_readername&#39;</span><span class="p">,</span> <span class="s1">&#39;FakeDataGenerator&#39;</span><span class="p">,</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
    <span class="n">_</span> <span class="o">+</span> <span class="s1">&#39;Reader&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s1">&#39;Files&#39;</span><span class="p">,</span> <span class="s1">&#39;LSL&#39;</span><span class="p">,</span> <span class="s1">&#39;Serial&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ADS1299SPI&#39;</span><span class="p">,</span> <span class="s1">&#39;ESP32SPI&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SocketTCP&#39;</span><span class="p">,</span> <span class="s1">&#39;SocketUDP&#39;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">]</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># Reader MixIn and utilities</span>

<span class="n">_name_reader_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(\w+)_(\d+)\.pid$&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="validate_readername"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.validate_readername">[docs]</a><span class="k">def</span> <span class="nf">validate_readername</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>                                     <span class="c1"># noqa: E302</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Find suitable name for reader instance in syntax of::</span>
<span class="sd">        {ReaderName} {ID}</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
        <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">validate_filename</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;()[]&#39;</span>
    <span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;Reader &#39;</span> <span class="o">+</span> <span class="n">random_id</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">exist_files</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_name_reader_pattern</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">DIR_PID</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_name_reader_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">exist_files</span> <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">ids</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span></div>


<span class="k">class</span> <span class="nc">StatusMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">is_streaming</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_task&#39;</span><span class="p">):</span>
            <span class="n">alive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alive</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">alive</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;paused&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">realtime_samplerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_streaming</span><span class="p">():</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># 1. frequency of last point</span>
        <span class="c1">#  idx = self._index - 1</span>
        <span class="c1">#  dt = self._data[-1, idx] - self._data[-1, idx - 1]</span>
        <span class="c1">#  return 1 / dt if dt else 0</span>

        <span class="c1"># 2. averaged frequency of last frame</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span>
        <span class="n">dT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">/</span> <span class="n">dT</span> <span class="k">if</span> <span class="n">dT</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="c1"># TODO: May integret data processing algorithm in readers</span>
        <span class="c1">#  if isinstance(items, tuple):</span>
        <span class="c1">#      for item in items:</span>
        <span class="c1">#          self = self[item]</span>
        <span class="c1">#      return self</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">items</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">):</span>
            <span class="n">st</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;not initialized&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39; </span><span class="si">{}</span><span class="s1">Hz, </span><span class="si">{}</span><span class="s1">CHs, </span><span class="si">{:.2f}</span><span class="s1">Sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_channel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;closed&#39;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">format_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">nbytes</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)</span><span class="si">%s</span><span class="s1"> at 0x</span><span class="si">%x</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">ReaderIOMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">set_sample_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">sample_time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sample_rate</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sample_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sample_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_time</span> <span class="o">=</span> <span class="n">sample_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;started&#39;</span><span class="p">,</span> <span class="s1">&#39;resumed&#39;</span><span class="p">]:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Runtime sample rate changing is not suggested.&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> sample rate set to </span><span class="si">{}</span><span class="s1">, you may want to restart &#39;</span>
                        <span class="s1">&#39;reader now.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
            <span class="c1"># TODO: change info and re-configure self._data etc. at runtime.</span>
            <span class="c1">#  self.restart()</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">set_channel_num</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_channel</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_channel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ch</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;started&#39;</span><span class="p">,</span> <span class="s1">&#39;resumed&#39;</span><span class="p">]:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Runtime channel num changing is not suggested.&#39;</span><span class="p">)</span>
            <span class="c1">#  self.restart()</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Pick num_channel x 1 fresh data from buffer.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_channel_t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_channel_t</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Pick (num_channel + time_channel) x 1 fresh data from buffer.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_streaming</span><span class="p">():</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lasti</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">10.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; read data timeout&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lasti</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lasti</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Pick num_channel x window_size from buffer.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_frame_t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_frame_t</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Pick (num_channel + time_channel) x window_size from buffer.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_streaming</span><span class="p">():</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lasti</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">10.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; read data timeout&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lasti</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lasti</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">:],</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:</span><span class="n">idx</span><span class="p">]),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Pick (num_channel + time_channel) x window_size from buffer.</span>
<span class="sd">        Start from where index equals to 0.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_streaming</span><span class="p">():</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lasti</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_time</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_time</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; read data timeout&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lasti</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">]</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">:],</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:</span><span class="n">idx</span><span class="p">]),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CompatMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Methods defined here are for compatibility between all Readers.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">set_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">en</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reader setting: </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">en</span><span class="p">))</span>

    <span class="c1">#  enable_bias = False</span>
    <span class="c1">#  measure_impedance = False</span>

    <span class="k">def</span> <span class="nf">_check_num_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nch</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_channel</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> You want </span><span class="si">{}</span><span class="s1"> channels data but only </span><span class="si">{}</span><span class="s1"> is provided by `</span><span class="si">{}</span><span class="s1">`.&#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_channel</span><span class="p">,</span> <span class="n">nch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_source</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">nch</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_channel</span><span class="p">:</span>
            <span class="n">nch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_channel</span> <span class="ow">or</span> <span class="n">nch</span>
        <span class="k">if</span> <span class="n">nch</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_channel</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Change num_channel to </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_channel_num</span><span class="p">(</span><span class="n">nch</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_sample_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nfs</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nfs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unstable sample rate: </span><span class="si">{:.2f}</span><span class="s1">/</span><span class="si">{:.2f}</span><span class="s1"> Hz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">nfs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">))</span>
        <span class="c1"># TODO: set sample_rate</span>


<span class="k">class</span> <span class="nc">BaseReader</span><span class="p">(</span><span class="n">LoopTaskMixin</span><span class="p">,</span> <span class="n">ReaderIOMixin</span><span class="p">,</span> <span class="n">CompatMixin</span><span class="p">,</span> <span class="n">StatusMixin</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;embci.io.Reader&#39;</span>
    <span class="n">_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;LoopTaskMixin required attributes are defined here.&#39;&#39;&#39;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">LoopTaskMixin</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="c1"># stream control flags used by `embci.utils.LoopTaskMixin`</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">__flag_pause__</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">__flag_close__</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="c1"># Basic stream reader attributes.</span>
        <span class="c1"># These values may be accessed in another thread or process.</span>
        <span class="c1"># So make them multiprocessing.Value and serve as properties.</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;_index&#39;</span><span class="p">,</span>         <span class="n">c_uint16</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;__status__&#39;</span><span class="p">,</span>     <span class="n">c_char_p</span><span class="p">,</span>  <span class="sa">b</span><span class="s1">&#39;closed&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;__started__&#39;</span><span class="p">,</span>    <span class="n">c_bool</span><span class="p">,</span>    <span class="kc">False</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;input_source&#39;</span><span class="p">,</span>   <span class="n">c_char_p</span><span class="p">,</span>  <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;sample_rate&#39;</span><span class="p">,</span>    <span class="n">c_uint16</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;sample_time&#39;</span><span class="p">,</span>    <span class="n">c_float</span><span class="p">,</span>   <span class="mi">0</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;window_size&#39;</span><span class="p">,</span>    <span class="n">c_uint16</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;num_channel&#39;</span><span class="p">,</span>    <span class="n">c_uint8</span><span class="p">,</span>   <span class="mi">0</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;start_time&#39;</span><span class="p">,</span>     <span class="n">c_float</span><span class="p">,</span>   <span class="mi">0</span><span class="p">),</span>
        <span class="p">]:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;_mp_&#39;</span> <span class="o">+</span> <span class="n">name</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">BaseReader</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="n">c_char_p</span><span class="p">:</span>
                <span class="n">fget</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">:</span> <span class="p">(</span>                   <span class="c1"># noqa: E731</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span>
                <span class="n">fset</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">:</span> <span class="p">(</span>            <span class="c1"># noqa: E731</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">ensure_bytes</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fget</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">:</span> <span class="p">(</span>                   <span class="c1"># noqa: E731</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="n">fset</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">:</span> <span class="p">(</span>            <span class="c1"># noqa: E731</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">BaseReader</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">property</span><span class="p">(</span>
                <span class="n">fget</span><span class="p">,</span> <span class="n">fset</span><span class="p">,</span> <span class="n">fdel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="s1">&#39;property &#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">sample_time</span><span class="p">,</span> <span class="n">num_channel</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">input_source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="c1"># Update basic info with arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_sample_rate</span><span class="p">(</span><span class="n">sample_rate</span><span class="p">,</span> <span class="n">sample_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_channel_num</span><span class="p">(</span><span class="n">num_channel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_source</span> <span class="o">=</span> <span class="n">input_source</span> <span class="ow">or</span> <span class="s1">&#39;Unknown&#39;</span>

        <span class="c1"># Broadcast data to a lab-streaming-layer outlet.  Here we only need</span>
        <span class="c1"># to check one time whether broadcast is True. If put this work in</span>
        <span class="c1"># loop task, it will be checked thousands times.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">validate_readername</span><span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">datatype</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">get_boolean</span><span class="p">(</span><span class="n">broadcast</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pylsl</span><span class="o">.</span><span class="n">pylsl</span><span class="o">.</span><span class="n">string2fmt</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid data type: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lsl_send</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lsl_send</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Locked file used to share data among processes</span>
        <span class="n">pidfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DIR_PID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.pid&#39;</span><span class="p">)</span>
        <span class="n">mmapfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DIR_TMP</span><span class="p">,</span> <span class="s1">&#39;mmap_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_pid</span> <span class="o">=</span> <span class="n">LockedFile</span><span class="p">(</span><span class="n">pidfn</span><span class="p">,</span> <span class="n">pidfile</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_data</span> <span class="o">=</span> <span class="n">LockedFile</span><span class="p">(</span><span class="n">mmapfn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">)</span>

        <span class="c1"># Indexs used to output data</span>
        <span class="c1"># 0:Channel 1:Frame 2:All 3-5: NotUsed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lasti</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">LoopTaskMixin</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># lock files to protect writing permission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_pid</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">num_channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_data</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># register memory-mapped-file as data buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_mmap</span> <span class="o">=</span> <span class="n">mmap</span><span class="o">.</span><span class="n">mmap</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_mmap</span><span class="p">)</span>
        <span class="c1"># in case that restarted with smaller window_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lsl_send</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lsl_info</span> <span class="o">=</span> <span class="n">pylsl</span><span class="o">.</span><span class="n">StreamInfo</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;Reader Outlet&#39;</span><span class="p">,</span>
                <span class="n">channel_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_channel</span><span class="p">,</span> <span class="n">nominal_srate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">,</span>
                <span class="n">channel_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">source_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lsl_outlet</span> <span class="o">=</span> <span class="n">pylsl</span><span class="o">.</span><span class="n">StreamOutlet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lsl_info</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; pylsl outlet established&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loop_args</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop_func_lsl</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loop_args</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop_func</span><span class="p">,</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_loop_method</span> <span class="o">=</span> <span class="n">method</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_loop_method&#39;</span><span class="p">,</span> <span class="s1">&#39;process&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop_method</span> <span class="o">==</span> <span class="s1">&#39;block&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop_args</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop_method</span> <span class="o">==</span> <span class="s1">&#39;thread&#39;</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop_method</span> <span class="o">==</span> <span class="s1">&#39;process&#39;</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Process</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;unknown method </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop_method</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># LoopTask manager will close readers safely</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">LoopTaskMixin</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># remove reference to old data buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_mmap</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_data</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_pid</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; stream stopped&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">();</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>                <span class="c1"># noqa: E702</span>

    <span class="k">def</span> <span class="nf">_loop_func_lsl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_fetch</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lsl_outlet</span><span class="o">.</span><span class="n">push_sample</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_save</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_loop_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_fetch</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_save</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_data_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; cannot use this directly&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_data_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ts</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">num_channel</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Readers on different input sources</span>

<div class="viewcode-block" id="FakeDataGenerator"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.FakeDataGenerator">[docs]</a><span class="k">class</span> <span class="nc">FakeDataGenerator</span><span class="p">(</span><span class="n">BaseReader</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Generate random data.&#39;&#39;&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;FDGen&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">sample_time</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_channel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="n">k</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;input_source&#39;</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FakeDataGenerator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">sample_rate</span><span class="p">,</span> <span class="n">sample_time</span><span class="p">,</span> <span class="n">num_channel</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_data_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.9</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_channel</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span></div>


<div class="viewcode-block" id="FilesReader"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.FilesReader">[docs]</a><span class="k">class</span> <span class="nc">FilesReader</span><span class="p">(</span><span class="n">BaseReader</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Read data from file and simulate as a common data reader.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span>
                 <span class="n">sample_rate</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">sample_time</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_channel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exist</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Data file not exist: `</span><span class="si">%s</span><span class="s1">`&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">k</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;input_source&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">k</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.Reader&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FilesReader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">sample_rate</span><span class="p">,</span> <span class="n">sample_time</span><span class="p">,</span> <span class="n">num_channel</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

<div class="viewcode-block" id="FilesReader.hook_before"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.FilesReader.hook_before">[docs]</a>    <span class="k">def</span> <span class="nf">hook_before</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;try to open data file and load data into RAM&#39;&#39;&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; reading data file &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_source</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_source</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.mat&#39;</span><span class="p">):</span>
            <span class="n">actionname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_source</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_source</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">actionname</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_rate&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> load data with shape of </span><span class="si">{}</span><span class="s1">@</span><span class="si">{}</span><span class="s1">Hz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Invalid data shape!&#39;</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_channel</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> change num_channel to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_channel</span> <span class="o">=</span> <span class="n">n</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[:(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">sample_rate</span> <span class="ow">and</span> <span class="n">sample_rate</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> resample source data to </span><span class="si">{}</span><span class="s1">Hz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_g</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_source</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fif&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_source</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_source</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_g</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="k">def</span> <span class="nf">_get_data_g</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">d</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">yield</span> <span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;quit&#39;</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="k">def</span> <span class="nf">_data_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span></div>


<div class="viewcode-block" id="LSLReader"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.LSLReader">[docs]</a><span class="k">class</span> <span class="nc">LSLReader</span><span class="p">(</span><span class="n">BaseReader</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Connect to a data stream on localhost:port and read data into buffer.</span>
<span class="sd">    There should be at least one stream available.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;LSLReader&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">sample_time</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_channel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="n">k</span><span class="p">[</span><span class="s1">&#39;broadcast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LSLReader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">sample_rate</span><span class="p">,</span> <span class="n">sample_time</span><span class="p">,</span> <span class="n">num_channel</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>

<div class="viewcode-block" id="LSLReader.start"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.LSLReader.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Here we take window_size(sample_rate x sample_time) as max_buflen</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
        <span class="c1"># 1. find available streaming information</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; finding availabel outlets...  &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pylsl</span><span class="o">.</span><span class="n">StreamInfo</span><span class="p">):</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;info&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">find_pylsl_outlets</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lsl_inlet_info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="c1"># 2. start streaming task to fetch data into buffer continuously</span>
        <span class="c1">#  self.start_time = info.created_at()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">LSLReader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="o">**</span><span class="n">k</span><span class="p">)</span></div>

<div class="viewcode-block" id="LSLReader.hook_before"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.LSLReader.hook_before">[docs]</a>    <span class="k">def</span> <span class="nf">hook_before</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lsl_inlet_info</span><span class="o">.</span><span class="n">nominal_srate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fs</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">,</span> <span class="n">pylsl</span><span class="o">.</span><span class="n">IRREGULAR_RATE</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_sample_rate</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">nch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lsl_inlet_info</span><span class="o">.</span><span class="n">channel_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_num_channel</span><span class="p">(</span><span class="n">nch</span><span class="p">)</span>
        <span class="n">maxbuf</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_time</span> <span class="k">if</span> <span class="n">fs</span> <span class="k">else</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">//</span> <span class="mi">100</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lsl_inlet</span> <span class="o">=</span> <span class="n">pylsl</span><span class="o">.</span><span class="n">StreamInlet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lsl_inlet_info</span><span class="p">,</span> <span class="n">maxbuf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_source</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">@</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lsl_inlet_info</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lsl_inlet_info</span><span class="o">.</span><span class="n">source_id</span><span class="p">())</span></div>

<div class="viewcode-block" id="LSLReader.hook_after"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.LSLReader.hook_after">[docs]</a>    <span class="k">def</span> <span class="nf">hook_after</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lsl_inlet</span><span class="o">.</span><span class="n">close_stream</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_data_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;LSL Inlet may buffer data. So do NOT use absolute time.&#39;&#39;&#39;</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lsl_inlet</span><span class="o">.</span><span class="n">pull_sample</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SkipIteration</span><span class="p">(</span><span class="s1">&#39;bad data from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lsl_inlet</span><span class="p">)</span>
        <span class="c1">#  return data, time.time() - self.start_time</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">ts</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lsl_inlet</span><span class="o">.</span><span class="n">time_correction</span><span class="p">()</span></div>


<div class="viewcode-block" id="SerialReader"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.SerialReader">[docs]</a><span class="k">class</span> <span class="nc">SerialReader</span><span class="p">(</span><span class="n">BaseReader</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Connect to a serial port and fetch data into buffer.</span>
<span class="sd">    There should be at least one port available.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;SerialReader&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">sample_time</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_channel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SerialReader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">sample_rate</span><span class="p">,</span> <span class="n">sample_time</span><span class="p">,</span> <span class="n">num_channel</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serial</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">()</span>

<div class="viewcode-block" id="SerialReader.start"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.SerialReader.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="mi">115200</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serial</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span> <span class="ow">or</span> <span class="n">find_serial_ports</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serial</span><span class="o">.</span><span class="n">baudrate</span> <span class="o">=</span> <span class="n">baudrate</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">SerialReader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="o">**</span><span class="n">k</span><span class="p">)</span></div>

<div class="viewcode-block" id="SerialReader.hook_before"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.SerialReader.hook_before">[docs]</a>    <span class="k">def</span> <span class="nf">hook_before</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serial</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_source</span> <span class="o">=</span> <span class="s1">&#39;Serial@</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_serial</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; `</span><span class="si">%s</span><span class="s1">` opened.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_num_channel</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_fetch</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span></div>

<div class="viewcode-block" id="SerialReader.hook_after"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.SerialReader.hook_after">[docs]</a>    <span class="k">def</span> <span class="nf">hook_after</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serial</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_data_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#  data = self._serial.read_until().decode(&#39;utf-8&#39;)</span>
        <span class="c1">#  data = [i.strip() for i in data.split(&#39;,&#39;)]</span>
        <span class="c1">#  data = np.array([float(i) for i in data if i], self._dtype)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_serial</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span></div>


<div class="viewcode-block" id="ADS1299SPIReader"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.ADS1299SPIReader">[docs]</a><span class="k">class</span> <span class="nc">ADS1299SPIReader</span><span class="p">(</span><span class="n">BaseReader</span><span class="p">,</span> <span class="n">Singleton</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Read data through SPI connection with ADS1299.</span>
<span class="sd">    This Reader is only used on ARM. It depends on class ADS1299_API.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">API</span> <span class="o">=</span> <span class="n">ADS1299_API</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;ADS1299Reader&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">sample_time</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_channel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">measure_impedance</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enable_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">API</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_api</span> <span class="o">=</span> <span class="p">(</span><span class="n">API</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">API</span><span class="p">)()</span>
        <span class="n">k</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;input_source&#39;</span><span class="p">,</span> <span class="s1">&#39;normal&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ADS1299SPIReader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">sample_rate</span><span class="p">,</span> <span class="n">sample_time</span><span class="p">,</span> <span class="n">num_channel</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_bias</span> <span class="o">=</span> <span class="n">enable_bias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure_impedance</span> <span class="o">=</span> <span class="n">measure_impedance</span>

<div class="viewcode-block" id="ADS1299SPIReader.set_channel"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.ADS1299SPIReader.set_channel">[docs]</a>    <span class="k">def</span> <span class="nf">set_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">en</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">set_channel</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">get_boolean</span><span class="p">(</span><span class="n">en</span><span class="p">))</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; invalid channel </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> channel </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="s1">&#39;enabled&#39;</span> <span class="k">if</span> <span class="n">en</span> <span class="k">else</span> <span class="s1">&#39;disabled&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">enable_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Whether to enable BIAS output on BIAS pin&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">enable_bias</span>

    <span class="nd">@enable_bias</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">enable_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">enable_bias</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">measure_impedance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Whether to measure impedance in Ohm or raw signal in Volt&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">measure_impedance</span>

    <span class="nd">@measure_impedance</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">measure_impedance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">measure_impedance</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="ADS1299SPIReader.set_sample_rate"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.ADS1299SPIReader.set_sample_rate">[docs]</a>    <span class="k">def</span> <span class="nf">set_sample_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">set_sample_rate</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; invalid sample rate </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rate</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ADS1299SPIReader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_sample_rate</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ensure_unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mp_input_source</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@input_source</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">input_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">set_input_source</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; invalid input source </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mp_input_source</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">ensure_bytes</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; input source set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="ADS1299SPIReader.start"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.ADS1299SPIReader.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">_dev</span> <span class="o">=</span> <span class="n">device</span> <span class="ow">and</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="ow">or</span> <span class="n">find_spi_devices</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ADS1299SPIReader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="o">**</span><span class="n">k</span><span class="p">)</span></div>

<div class="viewcode-block" id="ADS1299SPIReader.hook_before"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.ADS1299SPIReader.hook_before">[docs]</a>    <span class="k">def</span> <span class="nf">hook_before</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">_dev</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; `/dev/spidev</span><span class="si">%d</span><span class="s1">-</span><span class="si">%d</span><span class="s1">` opened.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">_dev</span><span class="p">)</span></div>
        <span class="c1">#  self._check_num_channel()</span>

<div class="viewcode-block" id="ADS1299SPIReader.hook_after"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.ADS1299SPIReader.hook_after">[docs]</a>    <span class="k">def</span> <span class="nf">hook_after</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_data_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>


<div class="viewcode-block" id="ESP32SPIReader"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.ESP32SPIReader">[docs]</a><span class="k">class</span> <span class="nc">ESP32SPIReader</span><span class="p">(</span><span class="n">ADS1299SPIReader</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Read data through SPI connection with onboard ESP32.</span>
<span class="sd">    This Reader is only used on ARM. It depends on class ESP32_API.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">API</span> <span class="o">=</span> <span class="n">ESP32_API</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;ESP32Reader&#39;</span></div>


<div class="viewcode-block" id="SocketTCPReader"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.SocketTCPReader">[docs]</a><span class="k">class</span> <span class="nc">SocketTCPReader</span><span class="p">(</span><span class="n">BaseReader</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A reader that recieve data from specific host and port through TCP socket.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;SocketTCPReader&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">sample_time</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_channel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SocketTCPReader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">sample_rate</span><span class="p">,</span> <span class="n">sample_time</span><span class="p">,</span> <span class="n">num_channel</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>

<div class="viewcode-block" id="SocketTCPReader.hook_before"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.SocketTCPReader.hook_before">[docs]</a>    <span class="k">def</span> <span class="nf">hook_before</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># IP addr and port are offered by user, connect to host:port</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; configure IP address&#39;</span><span class="p">)</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">rst</span> <span class="o">=</span> <span class="n">check_input</span><span class="p">((</span>
                <span class="n">extra</span> <span class="o">+</span> <span class="s1">&#39;Please input an address &quot;host:port&quot;.</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;Type `quit` to abort.</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;&gt; 192.168.0.1:8888 (example)</span><span class="se">\n</span><span class="s1">&gt; &#39;</span>
            <span class="p">),</span> <span class="p">{})</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">)</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">rst</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;quit&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; manual exit.&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rst</span><span class="p">:</span>
                    <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">rst</span><span class="p">,</span> <span class="mi">80</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">rst</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="n">socket</span><span class="o">.</span><span class="n">inet_aton</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>  <span class="c1"># check if host is valid string</span>
                <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">port</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="n">extra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; Invalid host: `</span><span class="si">%s</span><span class="s1">`</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">host</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>
                <span class="n">extra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; Invalid port: `</span><span class="si">%s</span><span class="s1">`</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">port</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; five times failed.&#39;</span><span class="p">)</span>
        <span class="c1"># TCP IPv4 socket connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client_size</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="o">.</span><span class="n">itemsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_source</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_num_channel</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_fetch</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_channel</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="o">.</span><span class="n">itemsize</span></div>

<div class="viewcode-block" id="SocketTCPReader.hook_after"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.SocketTCPReader.hook_after">[docs]</a>    <span class="k">def</span> <span class="nf">hook_after</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Keep in mind that socket `client` is continously receiving from server</span>
<span class="sd">        in other process/thread, so directly close client is dangerous because</span>
<span class="sd">        client may be blocking that process/thread by client.recv(n). We need</span>
<span class="sd">        to let server socket close the connection.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;shutdown&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SHUT_RDWR</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">_data_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_client_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span></div>


<div class="viewcode-block" id="SocketUDPReader"><a class="viewcode-back" href="../../../apis/io/readers.html#embci.io.readers.SocketUDPReader">[docs]</a><span class="k">class</span> <span class="nc">SocketUDPReader</span><span class="p">(</span><span class="n">SocketTCPReader</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Socket UDP client, data receiver. Under development.&#39;&#39;&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;SocketUDPReader&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">sample_time</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_channel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">):</span>
        <span class="c1"># sample_rate, sample_time, num_channel, name=None</span>
        <span class="c1"># input_source=None, broadcast=False, datatype=None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SocketUDPReader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">sample_rate</span><span class="p">,</span> <span class="n">sample_time</span><span class="p">,</span> <span class="n">num_channel</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<span class="c1"># THE END</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2019, Hankso and individual contributors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>